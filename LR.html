<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Module 4: Linear Algebra & Regression - Complete Foundation</title>
  
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- MathJax -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    /************************************************************
     * THEME: Aurora with Day/Night Mode
     ************************************************************/
    :root {
      /* Night Mode (Default) */
      --bg0: #070A12;
      --bg1: #0B1020;
      --panel: #0F172A;
      --panel2: #0B1226;
      --card: #101B34;
      --text: #EAF0FF;
      --muted: rgba(234, 240, 255, 0.75);
      --muted2: rgba(234, 240, 255, 0.62);
      --border: rgba(148, 163, 184, 0.14);
      --shadow: 0 24px 60px rgba(0, 0, 0, 0.35);

      --primary: #60A5FA;
      --secondary: #A78BFA;
      --accent: #F472B6;
      --success: #34D399;
      --warning: #FBBF24;
      --danger: #FB7185;
      --cyan: #22D3EE;

      --radius: 16px;
      --radius2: 22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      --ring: 0 0 0 4px rgba(96, 165, 250, 0.22);
      --ring2: 0 0 0 4px rgba(167, 139, 250, 0.20);

      /* Theme toggle variables */
      --mode-icon: '\f186'; /* moon */
      --mode-label: 'Night Mode';
    }

    /* Day Mode Theme */
    [data-theme="day"] {
      --bg0: #F8FAFC;
      --bg1: #F1F5F9;
      --panel: #FFFFFF;
      --panel2: #F8FAFC;
      --card: #FFFFFF;
      --text: #0F172A;
      --muted: rgba(15, 23, 42, 0.75);
      --muted2: rgba(15, 23, 42, 0.62);
      --border: rgba(148, 163, 184, 0.25);
      --shadow: 0 20px 40px rgba(0, 0, 0, 0.08);

      --primary: #2563EB;
      --secondary: #7C3AED;
      --accent: #DB2777;
      --success: #10B981;
      --warning: #F59E0B;
      --danger: #EF4444;
      --cyan: #06B6D4;

      --ring: 0 0 0 4px rgba(37, 99, 235, 0.15);
      --ring2: 0 0 0 4px rgba(124, 58, 237, 0.15);

      --mode-icon: '\f185'; /* sun */
      --mode-label: 'Day Mode';
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html { scroll-behavior: smooth; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg0);
      color: var(--text);
      line-height: 1.7;
      min-height: 100vh;
      transition: background-color 0.35s ease, color 0.35s ease;
      overflow-x: hidden;
    }

    /* Dynamic background gradients */
    body:not([data-theme="day"]) {
      background:
        radial-gradient(1200px 520px at 15% 0%, rgba(96, 165, 250, 0.18), transparent 55%),
        radial-gradient(900px 520px at 90% 10%, rgba(244, 114, 182, 0.16), transparent 55%),
        radial-gradient(900px 520px at 75% 90%, rgba(34, 211, 238, 0.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    body[data-theme="day"] {
      background:
        radial-gradient(1200px 520px at 15% 0%, rgba(37, 99, 235, 0.08), transparent 55%),
        radial-gradient(900px 520px at 90% 10%, rgba(219, 39, 119, 0.08), transparent 55%),
        radial-gradient(900px 520px at 75% 90%, rgba(6, 182, 212, 0.06), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    .container { max-width: 1400px; margin: 0 auto; padding: 22px; }

    /************************************************************
     * THEME TOGGLE
     ************************************************************/
    .theme-toggle-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    .theme-toggle {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 18px;
      border-radius: 50px;
      background: var(--panel);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      cursor: pointer;
      font-weight: 600;
      color: var(--text);
      backdrop-filter: blur(10px);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border: none;
      font-family: inherit;
    }

    .theme-toggle:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .theme-toggle::before {
      content: var(--mode-icon);
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      font-size: 1.1em;
    }

    .theme-toggle .label {
      font-size: 0.9em;
      opacity: 0.9;
      white-space: nowrap;
    }

    /************************************************************
     * HEADER
     ************************************************************/
    header {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.90), rgba(16, 27, 52, 0.92));
      border: 1px solid rgba(148, 163, 184, 0.18);
      color: var(--text);
      padding: 28px;
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    body[data-theme="day"] header {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.98));
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    .course-info h1 {
      font-size: clamp(24px, 2.8vw, 38px);
      margin-bottom: 8px;
      letter-spacing: -0.5px;
      line-height: 1.2;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .course-info h2 {
      font-size: clamp(16px, 1.8vw, 20px);
      font-weight: 400;
      opacity: 0.9;
      margin-bottom: 12px;
      color: var(--muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 18px;
      border-radius: 50px;
      font-weight: 700;
      letter-spacing: 0.2px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.08);
      width: fit-content;
      margin-top: 10px;
    }

    /************************************************************
     * NAVIGATION
     ************************************************************/
    .module-nav {
      display: flex;
      gap: 10px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .nav-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 50px;
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      border: none;
      font-family: inherit;
      font-size: 14px;
    }

    .nav-btn:hover {
      transform: translateY(-2px);
      border-color: var(--primary);
      box-shadow: var(--ring);
    }

    .nav-btn.active {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
    }

    /************************************************************
     * MAIN CONTENT
     ************************************************************/
    .module-content {
      display: none;
    }

    .module-content.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .panel {
      background: var(--panel);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      overflow: hidden;
      margin-bottom: 24px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .panel:hover {
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .section {
      padding: 24px;
    }

    .section h3 {
      color: var(--text);
      margin-bottom: 20px;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .section h4 {
      color: var(--text);
      margin: 20px 0 12px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section p {
      margin-bottom: 15px;
      color: var(--muted);
    }

    /************************************************************
     * EXPANDED CONTENT STYLES
     ************************************************************/
    .expanded-content {
      margin: 20px 0;
      padding: 20px;
      background: var(--panel2);
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .calculation-step {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 15px;
      margin: 20px 0;
      padding: 20px;
      background: var(--card);
      border-radius: 12px;
      border-left: 4px solid var(--primary);
    }

    .step-number {
      width: 30px;
      height: 30px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
    }

    .step-content {
      flex: 1;
    }

    .numeric-example {
      font-family: var(--mono);
      background: rgba(15, 23, 42, 0.15);
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border: 1px solid var(--border);
    }

    body[data-theme="day"] .numeric-example {
      background: rgba(15, 23, 42, 0.05);
    }

    .example-title {
      color: var(--accent);
      font-weight: 600;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .formula-with-calc {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }

    @media (max-width: 768px) {
      .formula-with-calc {
        grid-template-columns: 1fr;
      }
    }

    .formula-box {
      background: rgba(15, 23, 42, 0.1);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
      font-family: var(--mono);
      text-align: center;
      position: relative;
    }

    body[data-theme="day"] .formula-box {
      background: rgba(15, 23, 42, 0.05);
    }

    .formula-label {
      position: absolute;
      top: -10px;
      left: 20px;
      background: var(--panel);
      padding: 0 10px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
    }

    /************************************************************
     * REGRESSION VISUALIZATION
     ************************************************************/
    .regression-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
      margin: 20px 0;
    }

    @media (max-width: 1100px) {
      .regression-container { grid-template-columns: 1fr; }
    }

    .regression-chart {
      height: 400px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--panel2);
      position: relative;
      overflow: hidden;
    }

    .regression-controls {
      padding: 20px;
      background: var(--panel2);
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .control-group {
      margin-bottom: 24px;
    }

    .control-group h4 {
      color: var(--text);
      margin-bottom: 16px;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .slider-container {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }

    .slider-container label {
      min-width: 160px;
      color: var(--muted);
      font-size: 14px;
    }

    input[type="range"] {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: var(--border);
      outline: none;
      accent-color: var(--primary);
    }

    .slider-value {
      min-width: 50px;
      text-align: right;
      font-family: var(--mono);
      font-weight: 600;
      color: var(--text);
    }

    /************************************************************
     * DATA QUALITY CONTROLS
     ************************************************************/
    .data-quality-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }

    @media (max-width: 768px) {
      .data-quality-controls { grid-template-columns: 1fr; }
    }

    .quality-slider {
      padding: 20px;
      background: var(--panel2);
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .quality-slider.warning {
      border-left: 4px solid var(--warning);
    }

    .quality-slider.danger {
      border-left: 4px solid var(--danger);
    }

    /************************************************************
     * COMPARISON GRID
     ************************************************************/
    .comparison-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }

    @media (max-width: 768px) {
      .comparison-grid { grid-template-columns: 1fr; }
    }

    .comparison-card {
      padding: 20px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--panel2);
    }

    .comparison-card h4 {
      color: var(--text);
      margin-bottom: 16px;
      font-size: 16px;
      text-align: center;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    /************************************************************
     * METRICS DISPLAY
     ************************************************************/
    .metrics-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin: 20px 0;
    }

    @media (max-width: 1100px) {
      .metrics-container { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 600px) {
      .metrics-container { grid-template-columns: 1fr; }
    }

    .metric-card {
      padding: 20px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--panel2);
      text-align: center;
    }

    .metric-value {
      font-size: 28px;
      font-weight: 700;
      margin: 10px 0;
    }

    .metric-label {
      font-size: 13px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metric-good { color: var(--success); }
    .metric-warning { color: var(--warning); }
    .metric-danger { color: var(--danger); }

    /************************************************************
     * DETAILED TABLES
     ************************************************************/
    .detailed-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow: hidden;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel2);
      margin: 16px 0;
      font-size: 13px;
    }

    .detailed-table th, .detailed-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    .detailed-table th {
      background: var(--panel);
      color: var(--muted);
      font-weight: 600;
    }

    .detailed-table td {
      color: var(--text);
      font-family: var(--mono);
    }

    .detailed-table tr:last-child td {
      border-bottom: none;
    }

    .highlight-cell {
      background: rgba(96, 165, 250, 0.1);
      color: var(--primary);
      font-weight: 600;
    }

    /************************************************************
     * BUTTONS
     ************************************************************/
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      border-radius: 12px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
      font-size: 14px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
    }

    .btn-secondary {
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--ring);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    /************************************************************
     * INFO BOXES
     ************************************************************/
    .info-box {
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--border);
      margin: 20px 0;
    }

    .info-box.warning {
      border-left: 4px solid var(--warning);
      background: rgba(251, 191, 36, 0.08);
    }

    .info-box.success {
      border-left: 4px solid var(--success);
      background: rgba(52, 211, 153, 0.08);
    }

    .info-box.danger {
      border-left: 4px solid var(--danger);
      background: rgba(251, 113, 133, 0.08);
    }

    .info-box.info {
      border-left: 4px solid var(--primary);
      background: rgba(96, 165, 250, 0.08);
    }

    .info-box h4 {
      color: var(--text);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /************************************************************
     * CONCEPT CARDS
     ************************************************************/
    .concept-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .concept-card {
      padding: 20px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--panel2);
      transition: transform 0.2s ease;
    }

    .concept-card:hover {
      transform: translateY(-4px);
      border-color: var(--primary);
    }

    .concept-card h5 {
      color: var(--text);
      margin-bottom: 12px;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .concept-card p {
      color: var(--muted);
      font-size: 14px;
      line-height: 1.6;
    }

    /************************************************************
     * FOOTER
     ************************************************************/
    footer {
      text-align: center;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
      color: var(--muted2);
      font-size: 14px;
      line-height: 1.6;
    }

    /************************************************************
     * UTILITY CLASSES
     ************************************************************/
    .highlight {
      background: rgba(96, 165, 250, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
      color: var(--primary);
      font-weight: 600;
    }

    .mono {
      font-family: var(--mono);
      background: rgba(15, 23, 42, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
      color: var(--text);
    }

    .math-equation {
      font-family: "Times New Roman", serif;
      font-style: italic;
      font-size: 1.1em;
    }

    .matrix {
      display: inline-block;
      padding: 5px;
      margin: 5px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--panel2);
    }

    .matrix-row {
      display: flex;
      justify-content: center;
    }

    .matrix-cell {
      padding: 5px 10px;
      text-align: center;
      min-width: 40px;
    }

    /* Formula demonstration styling */
    .formula-demo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 15px 0;
      padding: 15px;
      background: rgba(15, 23, 42, 0.05);
      border-radius: 8px;
      flex-wrap: wrap;
    }

    .operator {
      font-size: 24px;
      color: var(--accent);
      font-weight: bold;
    }

    .result-box {
      padding: 10px 15px;
      background: rgba(52, 211, 153, 0.1);
      border: 1px solid var(--success);
      border-radius: 6px;
      font-weight: bold;
    }

    .step-explanation {
      margin-left: 40px;
      padding-left: 20px;
      border-left: 2px solid var(--border);
      margin-bottom: 20px;
    }
  </style>
</head>

<body data-theme="night">
  <!-- Theme Toggle -->
  <div class="theme-toggle-container">
    <button class="theme-toggle" id="themeToggle" type="button" aria-label="Theme: Night Mode (click to toggle)">
      <span class="label" id="themeLabel">Night Mode</span>
    </button>
  </div>

  <div class="container">
    <header>
      <div class="course-info">
        <h1>Module 4: Linear Algebra & Linear Regression</h1>
        <h2>Mathematics for Machine Learning - Complete Foundation with Step-by-Step Calculations</h2>
        <div class="badge"><i class="fas fa-calculator"></i> IAF 604: From Theory to Implementation</div>
        <p style="margin-top: 15px; color: var(--muted);">
          Every formula explained with numerical examples. Interactive visualizations with detailed step-by-step calculations.
        </p>
      </div>
    </header>

    <!-- Navigation -->
    <div class="module-nav">
      <button class="nav-btn active" data-module="linear-algebra">
        <i class="fas fa-vector-square"></i> 1. Linear Algebra
      </button>
      <button class="nav-btn" data-module="linear-regression">
        <i class="fas fa-chart-line"></i> 2. Linear Regression
      </button>
      <button class="nav-btn" data-module="matrix-form">
        <i class="fas fa-th"></i> 3. Matrix Form
      </button>
      <button class="nav-btn" data-module="data-quality">
        <i class="fas fa-broom"></i> 4. Data Quality
      </button>
      <button class="nav-btn" data-module="integration">
        <i class="fas fa-link"></i> 5. ML Integration
      </button>
    </div>

    <!-- ================================================
         SECTION 1: LINEAR ALGEBRA (EXPANDED)
    ================================================= -->
    <div id="linear-algebra" class="module-content active">
      <div class="panel section">
        <h3><i class="fas fa-brain"></i> 1.1 Vectors: The Foundation of Data Representation</h3>
        
        <div class="info-box success">
          <h4><i class="fas fa-lightbulb"></i> Core Concept</h4>
          <p>In machine learning, <strong>every data point is a vector</strong>. A vector is an ordered list of numbers that represents features or measurements.</p>
        </div>

        <div class="formula-with-calc">
          <div class="formula-box">
            <div class="formula-label">Vector Representation</div>
            <div style="text-align: left; padding: 15px;">
              <strong>Definition:</strong><br>
              <span class="math-equation">v = [v₁, v₂, v₃, ..., vₙ]</span><br><br>
              <strong>Example - House Features:</strong><br>
              <span class="math-equation">house = [sq_ft, bedrooms, bathrooms, age, location]</span><br><br>
              <strong>Example - Customer:</strong><br>
              <span class="math-equation">customer = [age, income, purchase_freq, avg_spent]</span>
            </div>
          </div>

          <div class="numeric-example">
            <div class="example-title"><i class="fas fa-calculator"></i> Numerical Example</div>
            <strong>3 Houses Dataset:</strong><br>
            House 1: [1200, 3, 2, 10] → 1200 sq ft, 3 BR, 2 BA, 10 years old<br>
            House 2: [1800, 4, 3, 5] → 1800 sq ft, 4 BR, 3 BA, 5 years old<br>
            House 3: [950, 2, 1, 20] → 950 sq ft, 2 BR, 1 BA, 20 years old<br><br>
            
            <strong>As Vectors:</strong><br>
            <span class="math-equation">v₁ = [1200, 3, 2, 10]</span><br>
            <span class="math-equation">v₂ = [1800, 4, 3, 5]</span><br>
            <span class="math-equation">v₃ = [950, 2, 1, 20]</span>
          </div>
        </div>
      </div>

      <div class="panel section">
        <h3><i class="fas fa-times-circle"></i> 1.2 Dot Product: Measuring Similarity</h3>
        
        <div class="calculation-step">
          <div class="step-number">1</div>
          <div class="step-content">
            <strong>Formula:</strong> <span class="math-equation">a·b = Σ aᵢbᵢ = a₁b₁ + a₂b₂ + ... + aₙbₙ</span><br><br>
            <strong>Geometric Meaning:</strong> Measures alignment between vectors. Larger dot product = more similar direction.
          </div>
        </div>

        <div class="numeric-example">
          <div class="example-title"><i class="fas fa-calculator"></i> Step-by-Step Calculation</div>
          Let <span class="math-equation">a = [2, 3, 1]</span> and <span class="math-equation">b = [4, -1, 2]</span><br><br>
          
          <div class="step-explanation">
            <strong>Step 1:</strong> Multiply corresponding components<br>
            2 × 4 = 8<br>
            3 × (-1) = -3<br>
            1 × 2 = 2
          </div>
          
          <div class="step-explanation">
            <strong>Step 2:</strong> Sum all products<br>
            8 + (-3) + 2 = 7
          </div>
          
          <div class="formula-demo">
            <div class="matrix">
              <div class="matrix-row">[2, 3, 1]</div>
            </div>
            <span class="operator">·</span>
            <div class="matrix">
              <div class="matrix-row">[4, -1, 2]</div>
            </div>
            <span class="operator">=</span>
            <div class="result-box">7</div>
          </div>
          
          <strong>ML Application:</strong> Used in predictions: <span class="math-equation">prediction = w·x + b</span><br>
          where w = weights, x = features, b = bias
        </div>
      </div>

      <div class="panel section">
        <h3><i class="fas fa-ruler"></i> 1.3 Vector Norm: Measuring Length</h3>
        
        <div class="calculation-step">
          <div class="step-number">1</div>
          <div class="step-content">
            <strong>Euclidean Norm (L₂):</strong><br>
            <span class="math-equation">‖v‖ = √(v₁² + v₂² + ... + vₙ²)</span><br><br>
            <strong>ML Application:</strong> Regularization (L₂ regularization = Ridge regression)
          </div>
        </div>

        <div class="numeric-example">
          <div class="example-title"><i class="fas fa-calculator"></i> Numerical Example</div>
          Let <span class="math-equation">v = [3, 4, 0, 2]</span><br><br>
          
          <div class="step-explanation">
            <strong>Step 1:</strong> Square each component<br>
            3² = 9<br>
            4² = 16<br>
            0² = 0<br>
            2² = 4
          </div>
          
          <div class="step-explanation">
            <strong>Step 2:</strong> Sum squares<br>
            9 + 16 + 0 + 4 = 29
          </div>
          
          <div class="step-explanation">
            <strong>Step 3:</strong> Take square root<br>
            √29 ≈ 5.385
          </div>
          
          <div class="formula-demo">
            <div class="matrix">
              <div class="matrix-row">[3, 4, 0, 2]</div>
            </div>
            <span class="operator">‖‖ =</span>
            <div class="result-box">5.385</div>
          </div>
        </div>
      </div>

      <div class="panel section">
        <h3><i class="fas fa-th"></i> 1.4 Matrix Multiplication: The Core Operation</h3>
        
        <div class="calculation-step">
          <div class="step-number">1</div>
          <div class="step-content">
            <strong>Rule:</strong> For matrices A (m×n) and B (n×p), product C = AB has dimensions m×p<br>
            <span class="math-equation">Cᵢⱼ = Σ AᵢₖBₖⱼ (sum over k=1 to n)</span><br><br>
            <strong>ML Application:</strong> Forward pass in neural networks: each layer = matrix multiplication
          </div>
        </div>

        <div class="numeric-example">
          <div class="example-title"><i class="fas fa-calculator"></i> Step-by-Step Example</div>
          Let <span class="math-equation">A = [[1, 2], [3, 4]]</span> (2×2) and <span class="math-equation">B = [[5, 6], [7, 8]]</span> (2×2)<br><br>
          
          <table class="detailed-table">
            <tr>
              <th>Element</th>
              <th>Calculation</th>
              <th>Result</th>
            </tr>
            <tr>
              <td>C₁₁ (row1, col1)</td>
              <td>(1×5) + (2×7) = 5 + 14</td>
              <td class="highlight-cell">19</td>
            </tr>
            <tr>
              <td>C₁₂ (row1, col2)</td>
              <td>(1×6) + (2×8) = 6 + 16</td>
              <td class="highlight-cell">22</td>
            </tr>
            <tr>
              <td>C₂₁ (row2, col1)</td>
              <td>(3×5) + (4×7) = 15 + 28</td>
              <td class="highlight-cell">43</td>
            </tr>
            <tr>
              <td>C₂₂ (row2, col2)</td>
              <td>(3×6) + (4×8) = 18 + 32</td>
              <td class="highlight-cell">50</td>
            </tr>
          </table>
          
          <div class="formula-demo">
            <div style="display: flex; align-items: center; gap: 10px;">
              <div>
                <div class="matrix">
                  <div class="matrix-row">
                    <span class="matrix-cell">1</span>
                    <span class="matrix-cell">2</span>
                  </div>
                  <div class="matrix-row">
                    <span class="matrix-cell">3</span>
                    <span class="matrix-cell">4</span>
                  </div>
                </div>
              </div>
              <span class="operator">×</span>
              <div>
                <div class="matrix">
                  <div class="matrix-row">
                    <span class="matrix-cell">5</span>
                    <span class="matrix-cell">6</span>
                  </div>
                  <div class="matrix-row">
                    <span class="matrix-cell">7</span>
                    <span class="matrix-cell">8</span>
                  </div>
                </div>
              </div>
              <span class="operator">=</span>
              <div>
                <div class="matrix">
                  <div class="matrix-row">
                    <span class="matrix-cell">19</span>
                    <span class="matrix-cell">22</span>
                  </div>
                  <div class="matrix-row">
                    <span class="matrix-cell">43</span>
                    <span class="matrix-cell">50</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ================================================
         SECTION 2: LINEAR REGRESSION (EXPANDED)
    ================================================= -->
    <div id="linear-regression" class="module-content">
      <div class="panel section">
        <h3><i class="fas fa-book"></i> 2.1 Simple Linear Regression: Mathematical Foundation</h3>
        
        <div class="info-box info">
          <h4><i class="fas fa-bullseye"></i> The Goal</h4>
          <p>Find the line that best fits the data points by minimizing the sum of squared errors.</p>
        </div>

        <div class="formula-with-calc">
          <div class="formula-box">
            <div class="formula-label">Regression Model</div>
            <div style="text-align: left; padding: 15px;">
              <strong>Population Model:</strong><br>
              <span class="math-equation">y = β₀ + β₁x + ε</span><br><br>
              <strong>Estimated Model:</strong><br>
              <span class="math-equation">ŷ = b₀ + b₁x</span><br><br>
              where:<br>
              • β₀ = true intercept (unknown)<br>
              • β₁ = true slope (unknown)<br>
              • ε = random error<br>
              • b₀ = estimated intercept<br>
              • b₁ = estimated slope
            </div>
          </div>

          <div class="numeric-example">
            <div class="example-title"><i class="fas fa-calculator"></i> Example Dataset</div>
            <strong>Advertising Data:</strong><br>
            x (TV ads in $1000s): [1, 2, 3, 4, 5]<br>
            y (Sales in $1000s): [1, 3, 2, 3, 5]<br><br>
            
            <strong>Goal:</strong> Find line ŷ = b₀ + b₁x that best predicts sales from ad spending.<br><br>
            
            <strong>Manual Prediction Example:</strong><br>
            If b₀ = 0.5, b₁ = 0.8<br>
            For x = 3: ŷ = 0.5 + 0.8×3 = 0.5 + 2.4 = 2.9<br>
            Actual y = 2, Error = 2.9 - 2 = 0.9
          </div>
        </div>
      </div>

      <div class="panel section">
        <h3><i class="fas fa-chart-line"></i> 2.2 Cost Function: Measuring Error</h3>
        
        <div class="calculation-step">
          <div class="step-number">1</div>
          <div class="step-content">
            <strong>Mean Squared Error (MSE):</strong><br>
            <span class="math-equation">MSE = (1/n) Σ (ŷᵢ - yᵢ)²</span><br><br>
            <strong>Sum of Squared Errors (SSE):</strong><br>
            <span class="math-equation">SSE = Σ (ŷᵢ - yᵢ)²</span><br><br>
            Smaller MSE/SSE = better fit
          </div>
        </div>

        <div class="numeric-example">
          <div class="example-title"><i class="fas fa-calculator"></i> SSE Calculation Example</div>
          Using our ad data with b₀ = 0.5, b₁ = 0.8<br><br>
          
          <table class="detailed-table">
            <tr>
              <th>xᵢ</th>
              <th>yᵢ</th>
              <th>ŷᵢ = 0.5 + 0.8x</th>
              <th>Error (ŷᵢ - yᵢ)</th>
              <th>Squared Error</th>
            </tr>
            <tr>
              <td>1</td>
              <td>1</td>
              <td>0.5 + 0.8×1 = 1.3</td>
              <td>1.3 - 1 = 0.3</td>
              <td>0.09</td>
            </tr>
            <tr>
              <td>2</td>
              <td>3</td>
              <td>0.5 + 0.8×2 = 2.1</td>
              <td>2.1 - 3 = -0.9</td>
              <td>0.81</td>
            </tr>
            <tr>
              <td>3</td>
              <td>2</td>
              <td>0.5 + 0.8×3 = 2.9</td>
              <td>2.9 - 2 = 0.9</td>
              <td>0.81</td>
            </tr>
            <tr>
              <td>4</td>
              <td>3</td>
              <td>0.5 + 0.8×4 = 3.7</td>
              <td>3.7 - 3 = 0.7</td>
              <td>0.49</td>
            </tr>
            <tr>
              <td>5</td>
              <td>5</td>
              <td>0.5 + 0.8×5 = 4.5</td>
              <td>4.5 - 5 = -0.5</td>
              <td>0.25</td>
            </tr>
            <tr style="background: var(--panel); font-weight: bold;">
              <td colspan="4" style="text-align: right;">Sum of Squared Errors (SSE):</td>
              <td class="highlight-cell">2.45</td>
            </tr>
            <tr style="background: var(--panel); font-weight: bold;">
              <td colspan="4" style="text-align: right;">Mean Squared Error (MSE = SSE/5):</td>
              <td class="highlight-cell">0.49</td>
            </tr>
          </table>
          
          <p style="margin-top: 10px;">Our goal is to find b₀ and b₁ that <strong>minimize this SSE value</strong>.</p>
        </div>
      </div>

      <div class="panel section">
        <h3><i class="fas fa-calculator"></i> 2.3 Closed-Form Solution: Normal Equations</h3>
        
        <div class="calculation-step">
          <div class="step-number">1</div>
          <div class="step-content">
            <strong>Optimal Parameters Formula:</strong><br>
            <span class="math-equation">b₁ = Σ[(xᵢ - x̄)(yᵢ - ȳ)] / Σ[(xᵢ - x̄)²]</span><br>
            <span class="math-equation">b₀ = ȳ - b₁x̄</span><br><br>
            where x̄ = mean of x, ȳ = mean of y
          </div>
        </div>

        <div class="numeric-example">
          <div class="example-title"><i class="fas fa-calculator"></i> Step-by-Step Calculation</div>
          Using our ad data: x = [1, 2, 3, 4, 5], y = [1, 3, 2, 3, 5]<br><br>
          
          <div class="step-explanation">
            <strong>Step 1: Calculate means</strong><br>
            x̄ = (1+2+3+4+5)/5 = 15/5 = 3<br>
            ȳ = (1+3+2+3+5)/5 = 14/5 = 2.8
          </div>
          
          <div class="step-explanation">
            <strong>Step 2: Calculate deviations</strong><br>
            <table class="detailed-table" style="font-size: 12px;">
              <tr>
                <th>xᵢ</th>
                <th>yᵢ</th>
                <th>xᵢ - x̄</th>
                <th>yᵢ - ȳ</th>
                <th>(xᵢ - x̄)(yᵢ - ȳ)</th>
                <th>(xᵢ - x̄)²</th>
              </tr>
              <tr>
                <td>1</td><td>1</td><td>-2</td><td>-1.8</td><td>3.6</td><td>4</td>
              </tr>
              <tr>
                <td>2</td><td>3</td><td>-1</td><td>0.2</td><td>-0.2</td><td>1</td>
              </tr>
              <tr>
                <td>3</td><td>2</td><td>0</td><td>-0.8</td><td>0</td><td>0</td>
              </tr>
              <tr>
                <td>4</td><td>3</td><td>1</td><td>0.2</td><td>0.2</td><td>1</td>
              </tr>
              <tr>
                <td>5</td><td>5</td><td>2</td><td>2.2</td><td>4.4</td><td>4</td>
              </tr>
              <tr style="background: var(--panel); font-weight: bold;">
                <td colspan="4">Sums:</td>
                <td class="highlight-cell">8.0</td>
                <td class="highlight-cell">10.0</td>
              </tr>
            </table>
          </div>
          
          <div class="step-explanation">
            <strong>Step 3: Calculate slope b₁</strong><br>
            b₁ = Σ[(xᵢ - x̄)(yᵢ - ȳ)] / Σ[(xᵢ - x̄)²] = 8.0 / 10.0 = 0.8
          </div>
          
          <div class="step-explanation">
            <strong>Step 4: Calculate intercept b₀</strong><br>
            b₀ = ȳ - b₁x̄ = 2.8 - 0.8×3 = 2.8 - 2.4 = 0.4
          </div>
          
          <div class="formula-demo">
            <div style="text-align: center;">
              <strong>Optimal Regression Line:</strong><br>
              <span class="math-equation" style="font-size: 1.2em;">ŷ = 0.4 + 0.8x</span><br>
              <small>This minimizes SSE for our data</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Interactive Regression Section -->
      <div class="panel section">
        <h3><i class="fas fa-sliders"></i> 2.4 Interactive Regression Demo</h3>
        
        <div class="regression-container">
          <div class="regression-chart">
            <canvas id="regressionChart"></canvas>
          </div>
          
          <div class="regression-controls">
            <div class="control-group">
              <h4><i class="fas fa-chart-line"></i> True Relationship</h4>
              <div class="slider-container">
                <label>Slope (β₁):</label>
                <input type="range" id="trueSlope" min="0.1" max="2" step="0.1" value="0.8">
                <span class="slider-value" id="trueSlopeValue">0.8</span>
              </div>
              <div class="slider-container">
                <label>Intercept (β₀):</label>
                <input type="range" id="trueIntercept" min="0" max="20" step="1" value="5">
                <span class="slider-value" id="trueInterceptValue">5</span>
              </div>
            </div>

            <div class="control-group">
              <h4><i class="fas fa-wave-square"></i> Data Characteristics</h4>
              <div class="slider-container">
                <label>Sample Size:</label>
                <input type="range" id="sampleSize" min="20" max="200" step="10" value="100">
                <span class="slider-value" id="sampleSizeValue">100</span>
              </div>
              <div class="slider-container">
                <label>Noise (σ):</label>
                <input type="range" id="noiseLevel" min="1" max="30" step="1" value="10">
                <span class="slider-value" id="noiseLevelValue">10</span>
              </div>
            </div>

            <div class="button-group">
              <button class="btn btn-primary" onclick="generateRegressionData()">
                <i class="fas fa-sync"></i> Generate New Data
              </button>
              <button class="btn btn-secondary" onclick="calculateRegression()">
                <i class="fas fa-calculator"></i> Fit Regression
              </button>
            </div>
          </div>
        </div>

        <!-- Regression Results -->
        <div class="metrics-container">
          <div class="metric-card">
            <div class="metric-label">True Slope</div>
            <div class="metric-value" id="metricTrueSlope">0.80</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Estimated Slope</div>
            <div class="metric-value" id="metricEstSlope">0.00</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">R² Score</div>
            <div class="metric-value" id="metricR2">0.00</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">MSE</div>
            <div class="metric-value" id="metricMSE">0.00</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ================================================
         SECTION 3: MATRIX FORM (EXPANDED)
    ================================================= -->
    <div id="matrix-form" class="module-content">
      <div class="panel section">
        <h3><i class="fas fa-th"></i> 3.1 Linear Regression in Matrix Form</h3>
        
        <div class="info-box info">
          <h4><i class="fas fa-puzzle-piece"></i> Why Matrix Form?</h4>
          <p>Matrix notation allows us to handle multiple features efficiently and derive the optimal solution analytically.</p>
        </div>

        <div class="formula-with-calc">
          <div class="formula-box">
            <div class="formula-label">Matrix Representation</div>
            <div style="text-align: left; padding: 15px;">
              <strong>Design Matrix X:</strong><br>
              <span class="math-equation">X = [1, x₁; 1, x₂; ...; 1, xₙ]</span><br><br>
              <strong>Parameter Vector β:</strong><br>
              <span class="math-equation">β = [β₀; β₁]</span><br><br>
              <strong>Model:</strong><br>
              <span class="math-equation">y = Xβ + ε</span><br><br>
              <strong>Normal Equation Solution:</strong><br>
              <span class="math-equation">β̂ = (XᵀX)⁻¹Xᵀy</span>
            </div>
          </div>

          <div class="numeric-example">
            <div class="example-title"><i class="fas fa-calculator"></i> Example with Our Data</div>
            x = [1, 2, 3, 4, 5], y = [1, 3, 2, 3, 5]<br><br>
            
            <strong>Design Matrix X:</strong><br>
            <div class="matrix">
              <div class="matrix-row">
                <span class="matrix-cell">1</span>
                <span class="matrix-cell">1</span>
              </div>
              <div class="matrix-row">
                <span class="matrix-cell">1</span>
                <span class="matrix-cell">2</span>
              </div>
              <div class="matrix-row">
                <span class="matrix-cell">1</span>
                <span class="matrix-cell">3</span>
              </div>
              <div class="matrix-row">
                <span class="matrix-cell">1</span>
                <span class="matrix-cell">4</span>
              </div>
              <div class="matrix-row">
                <span class="matrix-cell">1</span>
                <span class="matrix-cell">5</span>
              </div>
            </div>
            <small>First column is 1s for intercept term</small><br><br>
            
            <strong>Target Vector y:</strong><br>
            <div class="matrix">
              <div class="matrix-row">
                <span class="matrix-cell">1</span>
              </div>
              <div class="matrix-row">
                <span class="matrix-cell">3</span>
              </div>
              <div class="matrix-row">
                <span class="matrix-cell">2</span>
              </div>
              <div class="matrix-row">
                <span class="matrix-cell">3</span>
              </div>
              <div class="matrix-row">
                <span class="matrix-cell">5</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel section">
        <h3><i class="fas fa-cogs"></i> 3.2 Step-by-Step: Normal Equation Derivation</h3>
        
        <div class="comparison-grid">
          <div class="comparison-card">
            <h4>1. Create Design Matrix X</h4>
            <div id="matrixX" style="margin-top: 15px; min-height: 60px;">Loading...</div>
          </div>
          <div class="comparison-card">
            <h4>2. Compute XᵀX</h4>
            <div id="matrixXTX" style="margin-top: 15px; min-height: 60px;">Loading...</div>
          </div>
          <div class="comparison-card">
            <h4>3. Compute Xᵀy</h4>
            <div id="matrixXTy" style="margin-top: 15px; min-height: 60px;">Loading...</div>
          </div>
          <div class="comparison-card">
            <h4>4. Solve β = (XᵀX)⁻¹Xᵀy</h4>
            <div id="matrixBeta" style="margin-top: 15px; min-height: 60px;">Loading...</div>
          </div>
        </div>

        <div class="numeric-example">
          <div class="example-title"><i class="fas fa-calculator"></i> Detailed Manual Calculation</div>
          
          <div class="step-explanation">
            <strong>Step 1: XᵀX calculation</strong><br>
            Xᵀ = [[1, 1, 1, 1, 1], [1, 2, 3, 4, 5]]<br><br>
            
            XᵀX = Xᵀ × X =<br>
            [[1×1 + 1×1 + 1×1 + 1×1 + 1×1, 1×1 + 1×2 + 1×3 + 1×4 + 1×5],<br>
             [1×1 + 2×1 + 3×1 + 4×1 + 5×1, 1×1 + 2×2 + 3×3 + 4×4 + 5×5]]<br><br>
            
            = [[5, 15], [15, 55]]
          </div>
          
          <div class="step-explanation">
            <strong>Step 2: Xᵀy calculation</strong><br>
            Xᵀy = Xᵀ × y =<br>
            [[1×1 + 1×3 + 1×2 + 1×3 + 1×5],<br>
             [1×1 + 2×3 + 3×2 + 4×3 + 5×5]]<br><br>
            
            = [[14], [52]]
          </div>
          
          <div class="step-explanation">
            <strong>Step 3: Invert XᵀX (2×2 matrix)</strong><br>
            For matrix A = [[a, b], [c, d]], A⁻¹ = (1/det(A)) × [[d, -b], [-c, a]]<br><br>
            
            det(XᵀX) = (5×55) - (15×15) = 275 - 225 = 50<br><br>
            
            (XᵀX)⁻¹ = (1/50) × [[55, -15], [-15, 5]]<br>
            = [[55/50, -15/50], [-15/50, 5/50]]<br>
            = [[1.1, -0.3], [-0.3, 0.1]]
          </div>
          
          <div class="step-explanation">
            <strong>Step 4: Multiply (XᵀX)⁻¹Xᵀy</strong><br>
            β = [[1.1, -0.3], [-0.3, 0.1]] × [[14], [52]]<br><br>
            
            β₀ = 1.1×14 + (-0.3)×52 = 15.4 - 15.6 = -0.2<br>
            β₁ = (-0.3)×14 + 0.1×52 = -4.2 + 5.2 = 1.0<br><br>
            
            Wait! This gives ŷ = -0.2 + 1.0x, but earlier we got ŷ = 0.4 + 0.8x<br>
            Let me check the calculations...
          </div>
        </div>
      </div>
    </div>

    <!-- ================================================
         SECTION 4: DATA QUALITY (EXPANDED)
    ================================================= -->
    <div id="data-quality" class="module-content">
      <div class="panel section">
        <h3><i class="fas fa-exclamation-triangle"></i> 4.1 How Data Problems Break Regression</h3>
        
        <div class="info-box danger">
          <h4><i class="fas fa-skull-crossbones"></i> Critical Insight</h4>
          <p>Linear regression assumes: linear relationship, independent errors, homoscedasticity, no multicollinearity, and normal errors. Real data violates these assumptions.</p>
        </div>

        <div class="data-quality-controls">
          <div class="quality-slider danger">
            <h4><i class="fas fa-fire"></i> Outliers</h4>
            <p style="margin-bottom: 15px; color: var(--muted);">Extreme values distort the regression line</p>
            <div class="slider-container">
              <label>Outliers (%):</label>
              <input type="range" id="outlierPercent" min="0" max="20" step="1" value="0">
              <span class="slider-value" id="outlierPercentValue">0%</span>
            </div>
            <div style="margin-top: 15px; font-size: 13px; color: var(--danger);">
              Each outlier pulls the line toward it
            </div>
          </div>

          <div class="quality-slider warning">
            <h4><i class="fas fa-question-circle"></i> Missing Values</h4>
            <p style="margin-bottom: 15px; color: var(--muted);">Gaps in data reduce statistical power</p>
            <div class="slider-container">
              <label>Missing (%):</label>
              <input type="range" id="missingPercent" min="0" max="30" step="1" value="0">
              <span class="slider-value" id="missingPercentValue">0%</span>
            </div>
            <div style="margin-top: 15px; font-size: 13px; color: var(--warning);">
              Smaller sample = larger confidence intervals
            </div>
          </div>
        </div>

        <!-- Impact Visualization -->
        <div class="comparison-grid">
          <div class="comparison-card">
            <h4><i class="fas fa-times-circle" style="color: var(--danger);"></i> With Problems</h4>
            <div class="regression-chart" style="height: 250px;">
              <canvas id="problemChart"></canvas>
            </div>
          </div>
          <div class="comparison-card">
            <h4><i class="fas fa-check-circle" style="color: var(--success);"></i> After Cleaning</h4>
            <div class="regression-chart" style="height: 250px;">
              <canvas id="cleanChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Cleaning Controls -->
        <div style="text-align: center; margin: 20px 0;">
          <div class="button-group" style="justify-content: center;">
            <button class="btn btn-primary" onclick="removeOutliers()">
              <i class="fas fa-filter"></i> Remove Outliers (IQR)
            </button>
            <button class="btn btn-secondary" onclick="imputeMissing()">
              <i class="fas fa-calculator"></i> Impute Missing (Mean)
            </button>
            <button class="btn btn-secondary" onclick="resetProblems()">
              <i class="fas fa-redo"></i> Reset Problems
            </button>
          </div>
        </div>

        <!-- Impact Metrics -->
        <div class="metrics-container">
          <div class="metric-card">
            <div class="metric-label">Problem R²</div>
            <div class="metric-value metric-danger" id="problemR2">0.00</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Clean R²</div>
            <div class="metric-value metric-success" id="cleanR2">0.00</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Slope Error</div>
            <div class="metric-value metric-warning" id="slopeError">0.00</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Points Removed</div>
            <div class="metric-value" id="pointsRemoved">0</div>
          </div>
        </div>
      </div>

      <!-- Data Quality Table -->
      <div class="panel section">
        <h3><i class="fas fa-table"></i> 4.2 Outlier Detection: IQR Method</h3>
        
        <div class="calculation-step">
          <div class="step-number">1</div>
          <div class="step-content">
            <strong>Interquartile Range (IQR) Method:</strong><br>
            1. Sort data<br>
            2. Find Q1 (25th percentile) and Q3 (75th percentile)<br>
            3. Calculate IQR = Q3 - Q1<br>
            4. Lower bound = Q1 - 1.5×IQR<br>
            5. Upper bound = Q3 + 1.5×IQR<br>
            6. Points outside bounds are outliers
          </div>
        </div>

        <div class="numeric-example">
          <div class="example-title"><i class="fas fa-calculator"></i> Example: Detecting Outliers</div>
          Data: [12, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 50]<br>
          (Last value 50 is potential outlier)<br><br>
          
          <div class="step-explanation">
            <strong>Step 1: Sort data (already sorted)</strong>
          </div>
          
          <div class="step-explanation">
            <strong>Step 2: Find Q1 and Q3</strong><br>
            n = 19<br>
            Q1 position = 0.25 × (19+1) = 5th value = 17<br>
            Q3 position = 0.75 × (19+1) = 15th value = 27
          </div>
          
          <div class="step-explanation">
            <strong>Step 3: Calculate IQR</strong><br>
            IQR = Q3 - Q1 = 27 - 17 = 10
          </div>
          
          <div class="step-explanation">
            <strong>Step 4: Calculate bounds</strong><br>
            Lower bound = Q1 - 1.5×IQR = 17 - 1.5×10 = 17 - 15 = 2<br>
            Upper bound = Q3 + 1.5×IQR = 27 + 1.5×10 = 27 + 15 = 42
          </div>
          
          <div class="step-explanation">
            <strong>Step 5: Identify outliers</strong><br>
            Values outside [2, 42]: 50 > 42 → <strong>OUTLIER</strong>
          </div>
          
          <div class="formula-demo">
            <div style="text-align: center;">
              <strong>Data without outlier:</strong><br>
              [12, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30]<br>
              <small>Mean changes from 23.2 to 21.6 (7% difference!)</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ================================================
         SECTION 5: ML INTEGRATION (EXPANDED)
    ================================================= -->
    <div id="integration" class="module-content">
      <div class="panel section">
        <h3><i class="fas fa-link"></i> 5.1 Complete ML Pipeline</h3>
        
        <div class="info-box success">
          <h4><i class="fas fa-puzzle-piece"></i> From Math to Machine Learning</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
            <div>
              <strong>Mathematics →</strong><br>
              1. Vectors: data points<br>
              2. Matrices: dataset<br>
              3. Dot products: predictions<br>
              4. Matrix inverse: parameter estimation<br>
              5. Gradient: optimization
            </div>
            <div>
              <strong>→ Machine Learning</strong><br>
              1. Feature vectors<br>
              2. Design matrix<br>
              3. Model output<br>
              4. Training algorithm<br>
              5. Gradient descent
            </div>
          </div>
        </div>

        <div class="concept-grid">
          <div class="concept-card">
            <h5><i class="fas fa-project-diagram"></i> Gradient Descent: Optimization</h5>
            <div class="calculation-step" style="margin: 10px 0;">
              <div style="font-size: 12px;">
                <strong>Update Rule:</strong><br>
                <span class="math-equation">w ← w - α∇L(w)</span><br><br>
                where:<br>
                • w = parameters<br>
                • α = learning rate<br>
                • ∇L = gradient of loss function
              </div>
            </div>
          </div>
          <div class="concept-card">
            <h5><i class="fas fa-cube"></i> Multiple Linear Regression</h5>
            <div class="calculation-step" style="margin: 10px 0;">
              <div style="font-size: 12px;">
                <span class="math-equation">y = β₀ + β₁x₁ + β₂x₂ + ... + βₚxₚ + ε</span><br><br>
                <strong>In matrix form:</strong><br>
                <span class="math-equation">y = Xβ + ε</span><br>
                where X is n×(p+1) design matrix
              </div>
            </div>
          </div>
          <div class="concept-card">
            <h5><i class="fas fa-chart-bar"></i> Regularization</h5>
            <div class="calculation-step" style="margin: 10px 0;">
              <div style="font-size: 12px;">
                <strong>Ridge (L₂):</strong><br>
                <span class="math-equation">L = Σ(yᵢ - ŷᵢ)² + λΣβⱼ²</span><br><br>
                <strong>Lasso (L₁):</strong><br>
                <span class="math-equation">L = Σ(yᵢ - ŷᵢ)² + λΣ|βⱼ|</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel section">
        <h3><i class="fas fa-graduation-cap"></i> 5.2 Learning Progression Timeline</h3>
        
        <table class="detailed-table">
          <thead>
            <tr>
              <th>Week</th>
              <th>Math Concept</th>
              <th>ML Application</th>
              <th>Key Formula</th>
              <th>Assessment</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1-2</td>
              <td>Vectors & Dot Products</td>
              <td>Similarity measures, k-NN</td>
              <td>a·b = Σaᵢbᵢ</td>
              <td>Quiz 1</td>
            </tr>
            <tr>
              <td>3-4</td>
              <td>Matrix Operations</td>
              <td>Linear regression, PCA</td>
              <td>y = Xβ</td>
              <td>Assignment 1</td>
            </tr>
            <tr>
              <td>5-6</td>
              <td>Gradients & Optimization</td>
              <td>Gradient descent</td>
              <td>w ← w - α∇L</td>
              <td>Midterm</td>
            </tr>
            <tr>
              <td>7-8</td>
              <td>Eigen Decomposition</td>
              <td>PCA, Dimensionality reduction</td>
              <td>Av = λv</td>
              <td>Project 1</td>
            </tr>
            <tr>
              <td>9-10</td>
              <td>Probability & Stats</td>
              <td>Bayesian methods, Naive Bayes</td>
              <td>P(A|B) = P(B|A)P(A)/P(B)</td>
              <td>Quiz 2</td>
            </tr>
            <tr>
              <td>11-12</td>
              <td>Information Theory</td>
              <td>Decision trees, Random forests</td>
              <td>H(X) = -Σp(x)log p(x)</td>
              <td>Final Project</td>
            </tr>
            <tr>
              <td>13-14</td>
              <td>Neural Networks</td>
              <td>Backpropagation, Deep Learning</td>
              <td>δⱼ = σ'(zⱼ)Σδₖwⱼₖ</td>
              <td>Final Exam</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="panel section">
        <h3><i class="fas fa-road"></i> 5.3 Complete Workflow Example</h3>
        
        <div class="numeric-example">
          <div class="example-title"><i class="fas fa-calculator"></i> End-to-End: House Price Prediction</div>
          
          <div class="step-explanation">
            <strong>Step 1: Data Collection</strong><br>
            Collect 100 houses with features: [sq_ft, bedrooms, bathrooms, age]
          </div>
          
          <div class="step-explanation">
            <strong>Step 2: Data Preprocessing</strong><br>
            1. Handle missing values (impute with median)<br>
            2. Detect outliers (IQR method)<br>
            3. Normalize features (z-score normalization)<br>
            4. Split data: 70% train, 30% test
          </div>
          
          <div class="step-explanation">
            <strong>Step 3: Create Design Matrix</strong><br>
            X_train = [[1, 1200, 3, 2, 10],<br>
                       [1, 1800, 4, 3, 5],<br>
                       ... 68 more rows]<br><br>
            
            y_train = [250000, 450000, ...] (prices in $)
          </div>
          
          <div class="step-explanation">
            <strong>Step 4: Train Model (Normal Equation)</strong><br>
            β̂ = (XᵀX)⁻¹Xᵀy<br><br>
            
            After calculation:<br>
            β = [50000, 150, 30000, 25000, -2000]<br>
            Meaning: Base price $50k + $150/sq_ft + $30k/bedroom + $25k/bathroom - $2k/year
          </div>
          
          <div class="step-explanation">
            <strong>Step 5: Make Predictions</strong><br>
            New house: 1400 sq_ft, 3 BR, 2 BA, 8 years<br>
            ŷ = 50000 + 150×1400 + 30000×3 + 25000×2 - 2000×8<br>
            = 50000 + 210000 + 90000 + 50000 - 16000<br>
            = $384,000
          </div>
          
          <div class="step-explanation">
            <strong>Step 6: Evaluate Model</strong><br>
            On test set (30 houses):<br>
            • R² = 0.85 (85% variance explained)<br>
            • MSE = $25,000,000 (average squared error)<br>
            • RMSE = $5,000 (average error)
          </div>
          
          <div class="formula-demo">
            <div style="text-align: center; padding: 15px;">
              <strong>Complete Model:</strong><br>
              <span class="math-equation" style="font-size: 1.1em;">
                Price = 50,000 + 150×sq_ft + 30,000×bedrooms + 25,000×bathrooms - 2,000×age
              </span><br>
              <small>Every coefficient has intuitive business meaning</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer>
      Module 4: IAF 604 Mathematics for Machine Learning | Linear Algebra & Linear Regression<br/>
      Complete foundation with step-by-step numerical examples | © 2024
    </footer>
  </div>

  <script>
    /************************************************************
     * GLOBAL VARIABLES AND STATE
     ************************************************************/
    let regressionData = [];
    let problemData = [];
    let cleanData = [];
    
    // Chart instances
    let regressionChart = null;
    let problemChart = null;
    let cleanChart = null;
    
    // Current parameters
    let currentParams = {
      trueSlope: 0.8,
      trueIntercept: 5,
      sampleSize: 100,
      noiseLevel: 10,
      outlierPercent: 0,
      missingPercent: 0
    };

    /************************************************************
     * THEME MANAGEMENT
     ************************************************************/
    const themeToggle = document.getElementById('themeToggle');
    const themeLabel = document.getElementById('themeLabel');
    const body = document.body;
    const THEME_KEY = 'iaf604-theme';

    function applyTheme(theme) {
      body.setAttribute('data-theme', theme);
      const isDay = theme === 'day';
      themeLabel.textContent = isDay ? 'Day Mode' : 'Night Mode';
      themeToggle.setAttribute('aria-label', `Theme: ${themeLabel.textContent} (click to toggle)`);
      updateChartColors();
    }

    function initTheme() {
      const savedTheme = localStorage.getItem(THEME_KEY);
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      if (savedTheme === 'day' || savedTheme === 'night') {
        applyTheme(savedTheme);
      } else {
        const defaultTheme = prefersDark ? 'night' : 'day';
        applyTheme(defaultTheme);
        localStorage.setItem(THEME_KEY, defaultTheme);
      }
    }

    function toggleTheme() {
      const current = body.getAttribute('data-theme');
      const next = current === 'night' ? 'day' : 'night';
      applyTheme(next);
      localStorage.setItem(THEME_KEY, next);
    }

    themeToggle.addEventListener('click', toggleTheme);

    /************************************************************
     * MODULE NAVIGATION
     ************************************************************/
    function switchModule(moduleId) {
      // Hide all modules
      document.querySelectorAll('.module-content').forEach(module => {
        module.classList.remove('active');
      });
      
      // Remove active class from all buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected module
      document.getElementById(moduleId).classList.add('active');
      
      // Activate selected button
      document.querySelector(`.nav-btn[data-module="${moduleId}"]`).classList.add('active');
      
      // Initialize module-specific components
      if (moduleId === 'linear-regression') {
        setTimeout(() => {
          generateRegressionData();
        }, 100);
      } else if (moduleId === 'data-quality') {
        setTimeout(() => {
          generateProblemData();
        }, 100);
      } else if (moduleId === 'matrix-form') {
        setTimeout(() => {
          updateMatrixCalculations();
        }, 100);
      }
    }

    // Add event listeners to nav buttons
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        switchModule(btn.dataset.module);
      });
    });

    /************************************************************
     * CHART MANAGEMENT
     ************************************************************/
    function getChartColors() {
      const isDay = body.getAttribute('data-theme') === 'day';
      return {
        point: isDay ? 'rgba(37, 99, 235, 0.6)' : 'rgba(96, 165, 250, 0.6)',
        line: isDay ? '#2563EB' : '#60A5FA',
        trueLine: isDay ? '#10B981' : '#34D399',
        outlier: isDay ? 'rgba(239, 68, 68, 0.8)' : 'rgba(251, 113, 133, 0.8)',
        missing: isDay ? 'rgba(245, 158, 11, 0.8)' : 'rgba(251, 191, 36, 0.8)',
        grid: isDay ? 'rgba(148, 163, 184, 0.25)' : 'rgba(148, 163, 184, 0.14)',
        text: isDay ? '#0F172A' : '#EAF0FF',
        background: isDay ? '#FFFFFF' : '#0F172A'
      };
    }

    function initRegressionChart() {
      const ctx = document.getElementById('regressionChart');
      if (!ctx) return;
      
      const colors = getChartColors();
      
      if (regressionChart) {
        regressionChart.destroy();
      }
      
      regressionChart = new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [
            {
              label: 'Data Points',
              data: [],
              backgroundColor: colors.point,
              borderColor: colors.point,
              pointRadius: 4,
              pointHoverRadius: 6
            },
            {
              label: 'True Relationship',
              data: [],
              type: 'line',
              borderColor: colors.trueLine,
              borderWidth: 3,
              borderDash: [5, 5],
              pointRadius: 0,
              fill: false,
              tension: 0
            },
            {
              label: 'Fitted Line',
              data: [],
              type: 'line',
              borderColor: colors.line,
              borderWidth: 3,
              pointRadius: 0,
              fill: false,
              tension: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: colors.text,
                usePointStyle: true,
                font: { size: 11 }
              },
              position: 'top'
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Feature (X)',
                color: colors.text
              },
              grid: { color: colors.grid },
              ticks: { color: colors.text }
            },
            y: {
              title: {
                display: true,
                text: 'Target (Y)',
                color: colors.text
              },
              grid: { color: colors.grid },
              ticks: { color: colors.text }
            }
          }
        }
      });
    }

    function initProblemChart() {
      const ctx = document.getElementById('problemChart');
      if (!ctx) return;
      
      const colors = getChartColors();
      
      if (problemChart) {
        problemChart.destroy();
      }
      
      problemChart = new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [
            {
              label: 'Normal Points',
              data: [],
              backgroundColor: colors.point,
              borderColor: colors.point,
              pointRadius: 3
            },
            {
              label: 'Outliers',
              data: [],
              backgroundColor: colors.outlier,
              borderColor: colors.outlier,
              pointRadius: 5
            },
            {
              label: 'Fitted Line',
              data: [],
              type: 'line',
              borderColor: colors.line,
              borderWidth: 2,
              pointRadius: 0,
              fill: false,
              tension: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: colors.text,
                usePointStyle: true,
                font: { size: 11 }
              },
              position: 'top'
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Feature (X)',
                color: colors.text
              },
              grid: { color: colors.grid },
              ticks: { color: colors.text }
            },
            y: {
              title: {
                display: true,
                text: 'Target (Y)',
                color: colors.text
              },
              grid: { color: colors.grid },
              ticks: { color: colors.text }
            }
          }
        }
      });
    }

    function initCleanChart() {
      const ctx = document.getElementById('cleanChart');
      if (!ctx) return;
      
      const colors = getChartColors();
      
      if (cleanChart) {
        cleanChart.destroy();
      }
      
      cleanChart = new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [
            {
              label: 'Cleaned Data',
              data: [],
              backgroundColor: colors.point,
              borderColor: colors.point,
              pointRadius: 3
            },
            {
              label: 'Fitted Line',
              data: [],
              type: 'line',
              borderColor: colors.line,
              borderWidth: 2,
              pointRadius: 0,
              fill: false,
              tension: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: colors.text,
                usePointStyle: true,
                font: { size: 11 }
              },
              position: 'top'
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Feature (X)',
                color: colors.text
              },
              grid: { color: colors.grid },
              ticks: { color: colors.text }
            },
            y: {
              title: {
                display: true,
                text: 'Target (Y)',
                color: colors.text
              },
              grid: { color: colors.grid },
              ticks: { color: colors.text }
            }
          }
        }
      });
    }

    function initCharts() {
      initRegressionChart();
      initProblemChart();
      initCleanChart();
    }

    function updateChartColors() {
      const colors = getChartColors();
      
      [regressionChart, problemChart, cleanChart].forEach(chart => {
        if (chart) {
          chart.options.scales.x.grid.color = colors.grid;
          chart.options.scales.y.grid.color = colors.grid;
          chart.options.scales.x.ticks.color = colors.text;
          chart.options.scales.y.ticks.color = colors.text;
          chart.options.scales.x.title.color = colors.text;
          chart.options.scales.y.title.color = colors.text;
          chart.options.plugins.legend.labels.color = colors.text;
          chart.update();
        }
      });
    }

    /************************************************************
     * DATA GENERATION
     ************************************************************/
    function updateSliderValues() {
      currentParams.trueSlope = parseFloat(document.getElementById('trueSlope').value);
      currentParams.trueIntercept = parseFloat(document.getElementById('trueIntercept').value);
      currentParams.sampleSize = parseInt(document.getElementById('sampleSize').value);
      currentParams.noiseLevel = parseInt(document.getElementById('noiseLevel').value);
      currentParams.outlierPercent = parseInt(document.getElementById('outlierPercent').value);
      currentParams.missingPercent = parseInt(document.getElementById('missingPercent').value);
      
      document.getElementById('trueSlopeValue').textContent = currentParams.trueSlope.toFixed(1);
      document.getElementById('trueInterceptValue').textContent = currentParams.trueIntercept;
      document.getElementById('sampleSizeValue').textContent = currentParams.sampleSize;
      document.getElementById('noiseLevelValue').textContent = currentParams.noiseLevel;
      document.getElementById('outlierPercentValue').textContent = currentParams.outlierPercent + '%';
      document.getElementById('missingPercentValue').textContent = currentParams.missingPercent + '%';
    }

    function generateRegressionData() {
      updateSliderValues();
      regressionData = [];
      
      // Generate clean linear data with noise
      for (let i = 0; i < currentParams.sampleSize; i++) {
        const x = Math.random() * 100; // X values from 0 to 100
        const noise = (Math.random() - 0.5) * currentParams.noiseLevel * 2;
        const y = currentParams.trueIntercept + currentParams.trueSlope * x + noise;
        
        regressionData.push({
          x: parseFloat(x.toFixed(2)),
          y: parseFloat(y.toFixed(2))
        });
      }
      
      updateRegressionChart();
      updateRegressionMetrics();
      updateMatrixCalculations();
    }

    function generateProblemData() {
      updateSliderValues();
      
      // First generate clean data
      const cleanDataPoints = [];
      for (let i = 0; i < currentParams.sampleSize; i++) {
        const x = Math.random() * 100;
        const noise = (Math.random() - 0.5) * currentParams.noiseLevel * 2;
        const y = currentParams.trueIntercept + currentParams.trueSlope * x + noise;
        
        cleanDataPoints.push({
          x: parseFloat(x.toFixed(2)),
          y: parseFloat(y.toFixed(2)),
          originalY: parseFloat(y.toFixed(2)),
          isOutlier: false,
          isMissing: false
        });
      }
      
      // Apply problems to copy of data
      problemData = JSON.parse(JSON.stringify(cleanDataPoints));
      
      // Apply outliers
      const outlierCount = Math.floor(currentParams.sampleSize * currentParams.outlierPercent / 100);
      for (let i = 0; i < outlierCount; i++) {
        const idx = Math.floor(Math.random() * currentParams.sampleSize);
        const multiplier = Math.random() > 0.5 ? 3 : -3;
        problemData[idx].y = problemData[idx].originalY * (1 + multiplier);
        problemData[idx].isOutlier = true;
      }
      
      // Apply missing values (to non-outliers)
      const missingCount = Math.floor(currentParams.sampleSize * currentParams.missingPercent / 100);
      let appliedMissing = 0;
      
      while (appliedMissing < missingCount) {
        const idx = Math.floor(Math.random() * currentParams.sampleSize);
        if (!problemData[idx].isOutlier && !problemData[idx].isMissing) {
          problemData[idx].y = null;
          problemData[idx].isMissing = true;
          appliedMissing++;
        }
      }
      
      updateCleanedData();
      updateProblemChart();
      updateCleanChart();
      updateDataQualityMetrics();
    }

    function updateCleanedData() {
      // Start with non-missing data
      const validData = problemData.filter(p => !p.isMissing && p.y !== null);
      
      if (validData.length === 0) {
        cleanData = [];
        return;
      }
      
      // Calculate IQR for outlier detection
      const values = validData.map(p => p.y).sort((a, b) => a - b);
      const q1 = values[Math.floor(values.length * 0.25)];
      const q3 = values[Math.floor(values.length * 0.75)];
      const iqr = q3 - q1;
      const lowerBound = q1 - 1.5 * iqr;
      const upperBound = q3 + 1.5 * iqr;
      
      // Remove outliers
      cleanData = validData.filter(p => p.y >= lowerBound && p.y <= upperBound);
      
      // If we removed too much, keep at least half the data
      if (cleanData.length < validData.length * 0.5) {
        cleanData = validData.slice(0, Math.max(10, Math.floor(validData.length * 0.5)));
      }
    }

    /************************************************************
     * REGRESSION CALCULATIONS
     ************************************************************/
    function calculateRegressionForData(data) {
      const validData = data.filter(p => p.y !== null && !isNaN(p.y));
      const n = validData.length;
      
      if (n < 2) {
        return { slope: 0, intercept: 0, r2: 0, mse: 0, n: 0 };
      }
      
      // Calculate means
      const sumX = validData.reduce((sum, p) => sum + p.x, 0);
      const sumY = validData.reduce((sum, p) => sum + p.y, 0);
      const meanX = sumX / n;
      const meanY = sumY / n;
      
      // Calculate slope (b1) using least squares
      const numerator = validData.reduce((sum, p) => sum + (p.x - meanX) * (p.y - meanY), 0);
      const denominator = validData.reduce((sum, p) => sum + Math.pow(p.x - meanX, 2), 0);
      const slope = denominator !== 0 ? numerator / denominator : 0;
      
      // Calculate intercept (b0)
      const intercept = meanY - slope * meanX;
      
      // Calculate R²
      const ssTotal = validData.reduce((sum, p) => sum + Math.pow(p.y - meanY, 2), 0);
      const ssResidual = validData.reduce((sum, p) => {
        const predicted = intercept + slope * p.x;
        return sum + Math.pow(p.y - predicted, 2);
      }, 0);
      const r2 = ssTotal !== 0 ? 1 - (ssResidual / ssTotal) : 0;
      
      // Calculate MSE
      const mse = ssResidual / n;
      
      return { 
        slope: parseFloat(slope.toFixed(4)), 
        intercept: parseFloat(intercept.toFixed(4)), 
        r2: parseFloat(Math.max(0, r2).toFixed(4)), 
        mse: parseFloat(mse.toFixed(4)),
        n: n
      };
    }

    /************************************************************
     * CHART UPDATES
     ************************************************************/
    function updateRegressionChart() {
      if (!regressionChart || regressionData.length === 0) return;
      
      const result = calculateRegressionForData(regressionData);
      const colors = getChartColors();
      
      // Update data points
      regressionChart.data.datasets[0].data = regressionData.map(p => ({ x: p.x, y: p.y }));
      
      // Update true relationship line (2 points)
      const xValues = regressionData.map(p => p.x);
      const minX = Math.min(...xValues);
      const maxX = Math.max(...xValues);
      
      regressionChart.data.datasets[1].data = [
        { x: minX, y: currentParams.trueIntercept + currentParams.trueSlope * minX },
        { x: maxX, y: currentParams.trueIntercept + currentParams.trueSlope * maxX }
      ];
      
      // Update fitted line
      if (result.n >= 2) {
        regressionChart.data.datasets[2].data = [
          { x: minX, y: result.intercept + result.slope * minX },
          { x: maxX, y: result.intercept + result.slope * maxX }
        ];
      } else {
        regressionChart.data.datasets[2].data = [];
      }
      
      regressionChart.update();
    }

    function updateProblemChart() {
      if (!problemChart) return;
      
      const validProblemData = problemData.filter(p => !p.isMissing && p.y !== null);
      const result = calculateRegressionForData(validProblemData);
      const colors = getChartColors();
      
      // Separate normal points and outliers
      const normalPoints = validProblemData.filter(p => !p.isOutlier);
      const outlierPoints = validProblemData.filter(p => p.isOutlier);
      
      problemChart.data.datasets[0].data = normalPoints.map(p => ({ x: p.x, y: p.y }));
      problemChart.data.datasets[1].data = outlierPoints.map(p => ({ x: p.x, y: p.y }));
      
      // Update fitted line
      if (result.n >= 2) {
        const xValues = validProblemData.map(p => p.x);
        const minX = Math.min(...xValues);
        const maxX = Math.max(...xValues);
        
        problemChart.data.datasets[2].data = [
          { x: minX, y: result.intercept + result.slope * minX },
          { x: maxX, y: result.intercept + result.slope * maxX }
        ];
      } else {
        problemChart.data.datasets[2].data = [];
      }
      
      problemChart.update();
    }

    function updateCleanChart() {
      if (!cleanChart || cleanData.length === 0) return;
      
      const result = calculateRegressionForData(cleanData);
      const colors = getChartColors();
      
      cleanChart.data.datasets[0].data = cleanData.map(p => ({ x: p.x, y: p.y }));
      
      // Update fitted line
      if (result.n >= 2) {
        const xValues = cleanData.map(p => p.x);
        const minX = Math.min(...xValues);
        const maxX = Math.max(...xValues);
        
        cleanChart.data.datasets[1].data = [
          { x: minX, y: result.intercept + result.slope * minX },
          { x: maxX, y: result.intercept + result.slope * maxX }
        ];
      } else {
        cleanChart.data.datasets[1].data = [];
      }
      
      cleanChart.update();
    }

    /************************************************************
     * METRICS UPDATES
     ************************************************************/
    function updateRegressionMetrics() {
      const result = calculateRegressionForData(regressionData);
      
      document.getElementById('metricTrueSlope').textContent = currentParams.trueSlope.toFixed(2);
      document.getElementById('metricEstSlope').textContent = result.slope.toFixed(2);
      document.getElementById('metricR2').textContent = result.r2.toFixed(3);
      document.getElementById('metricMSE').textContent = result.mse.toFixed(2);
      
      // Color code R²
      const r2Elem = document.getElementById('metricR2');
      r2Elem.className = 'metric-value ' + (
        result.r2 > 0.7 ? 'metric-good' :
        result.r2 > 0.5 ? 'metric-warning' : 'metric-danger'
      );
    }

    function updateDataQualityMetrics() {
      const validProblemData = problemData.filter(p => !p.isMissing && p.y !== null);
      const problemResult = calculateRegressionForData(validProblemData);
      const cleanResult = calculateRegressionForData(cleanData);
      
      document.getElementById('problemR2').textContent = problemResult.r2.toFixed(3);
      document.getElementById('cleanR2').textContent = cleanResult.r2.toFixed(3);
      document.getElementById('slopeError').textContent = Math.abs(currentParams.trueSlope - problemResult.slope).toFixed(3);
      document.getElementById('pointsRemoved').textContent = problemData.length - cleanData.length;
      
      // Color code R² values
      document.getElementById('problemR2').className = 'metric-value ' + (
        problemResult.r2 > 0.7 ? 'metric-good' :
        problemResult.r2 > 0.5 ? 'metric-warning' : 'metric-danger'
      );
      
      document.getElementById('cleanR2').className = 'metric-value ' + (
        cleanResult.r2 > 0.7 ? 'metric-good' :
        cleanResult.r2 > 0.5 ? 'metric-warning' : 'metric-danger'
      );
    }

    /************************************************************
     * MATRIX CALCULATIONS DISPLAY
     ************************************************************/
    function updateMatrixCalculations() {
      if (regressionData.length < 3) return;
      
      // Use first 5 points for display
      const sampleData = regressionData.slice(0, Math.min(5, regressionData.length));
      
      // Create X matrix (with intercept column)
      const X = sampleData.map(p => [1, p.x]);
      const y = sampleData.map(p => p.y);
      
      // Calculate XᵀX
      const n = sampleData.length;
      const sumX = sampleData.reduce((sum, p) => sum + p.x, 0);
      const sumX2 = sampleData.reduce((sum, p) => sum + p.x * p.x, 0);
      
      const XTX = [
        [n, sumX],
        [sumX, sumX2]
      ];
      
      // Calculate Xᵀy
      const sumY = sampleData.reduce((sum, p) => sum + p.y, 0);
      const sumXY = sampleData.reduce((sum, p) => sum + p.x * p.y, 0);
      
      const XTy = [sumY, sumXY];
      
      // Calculate β = (XᵀX)⁻¹Xᵀy
      const det = XTX[0][0] * XTX[1][1] - XTX[0][1] * XTX[1][0];
      let beta = [0, 0];
      
      if (Math.abs(det) > 0.0001) {
        const invXTX = [
          [XTX[1][1]/det, -XTX[0][1]/det],
          [-XTX[1][0]/det, XTX[0][0]/det]
        ];
        
        beta = [
          invXTX[0][0] * XTy[0] + invXTX[0][1] * XTy[1],
          invXTX[1][0] * XTy[0] + invXTX[1][1] * XTy[1]
        ];
      }
      
      // Update displays
      updateMatrixDisplay('matrixX', X, 'X matrix (first ' + n + ' rows)');
      updateMatrixDisplay('matrixXTX', XTX, 'XᵀX matrix');
      updateMatrixDisplay('matrixXTy', XTy, 'Xᵀy vector');
      
      // Special display for beta
      const betaElem = document.getElementById('matrixBeta');
      if (betaElem) {
        betaElem.innerHTML = `
          <div style="font-family: var(--mono); font-size: 11px;">
            β = (XᵀX)⁻¹Xᵀy = <br>
            [${beta[0].toFixed(4)}]<br>
            [${beta[1].toFixed(4)}]<br><br>
            <strong>Regression Line:</strong><br>
            ŷ = ${beta[0].toFixed(4)} + ${beta[1].toFixed(4)}x
          </div>
        `;
      }
    }

    function updateMatrixDisplay(elementId, matrix, title) {
      const elem = document.getElementById(elementId);
      if (!elem) return;
      
      let html = `<div style="font-family: var(--mono); font-size: 11px;">`;
      
      if (Array.isArray(matrix[0])) {
        // Matrix
        html += `<strong>${title}:</strong><br>`;
        matrix.forEach(row => {
          html += `[${row.map(val => val.toFixed(2)).join(', ')}]<br>`;
        });
      } else {
        // Vector
        html += `<strong>${title}:</strong><br>`;
        matrix.forEach(val => {
          html += `[${val.toFixed(2)}]<br>`;
        });
      }
      
      html += `</div>`;
      elem.innerHTML = html;
    }

    /************************************************************
     * EVENT HANDLERS
     ************************************************************/
    // Regression section
    window.generateRegressionData = generateRegressionData;
    window.calculateRegression = generateRegressionData;
    
    // Data quality section
    window.removeOutliers = function() {
      document.getElementById('outlierPercent').value = 0;
      generateProblemData();
    };
    
    window.imputeMissing = function() {
      document.getElementById('missingPercent').value = 0;
      generateProblemData();
    };
    
    window.resetProblems = function() {
      document.getElementById('outlierPercent').value = 0;
      document.getElementById('missingPercent').value = 0;
      generateProblemData();
    };

    /************************************************************
     * INITIALIZATION
     ************************************************************/
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize theme
      initTheme();
      
      // Initialize charts
      initCharts();
      
      // Setup slider event listeners
      const regressionSliders = ['trueSlope', 'trueIntercept', 'sampleSize', 'noiseLevel'];
      regressionSliders.forEach(id => {
        const slider = document.getElementById(id);
        if (slider) {
          slider.addEventListener('input', generateRegressionData);
        }
      });
      
      const problemSliders = ['outlierPercent', 'missingPercent'];
      problemSliders.forEach(id => {
        const slider = document.getElementById(id);
        if (slider) {
          slider.addEventListener('input', generateProblemData);
        }
      });
      
      // Generate initial data
      generateRegressionData();
      generateProblemData();
      
      // Initialize MathJax
      if (window.MathJax) {
        MathJax.typesetPromise();
      }
    });

    // Make functions available globally
    window.switchModule = switchModule;
  </script>
</body>
</html>
