<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Module 5: Supervised Machine Learning - Regression (Extended)</title>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- MathJax -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    /************************************************************
     * THEME: Aurora with Day/Night Mode
     ************************************************************/
    :root {
      /* Night Mode (Default) */
      --bg0: #070A12;
      --bg1: #0B1020;
      --panel: #0F172A;
      --panel2: #0B1226;
      --card: #101B34;
      --text: #EAF0FF;
      --muted: rgba(234, 240, 255, 0.75);
      --muted2: rgba(234, 240, 255, 0.62);
      --border: rgba(148, 163, 184, 0.14);
      --shadow: 0 24px 60px rgba(0, 0, 0, 0.35);

      --primary: #60A5FA;
      --secondary: #A78BFA;
      --accent: #F472B6;
      --success: #34D399;
      --warning: #FBBF24;
      --danger: #FB7185;
      --cyan: #22D3EE;

      --radius: 16px;
      --radius2: 22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      --ring: 0 0 0 4px rgba(96, 165, 250, 0.22);
      --ring2: 0 0 0 4px rgba(167, 139, 250, 0.20);

      /* Theme toggle variables */
      --mode-icon: '\f186'; /* moon */
      --mode-label: 'Night Mode';
    }

    /* Day Mode Theme */
    [data-theme="day"] {
      --bg0: #F8FAFC;
      --bg1: #F1F5F9;
      --panel: #FFFFFF;
      --panel2: #F8FAFC;
      --card: #FFFFFF;
      --text: #0F172A;
      --muted: rgba(15, 23, 42, 0.75);
      --muted2: rgba(15, 23, 42, 0.62);
      --border: rgba(148, 163, 184, 0.25);
      --shadow: 0 20px 40px rgba(0, 0, 0, 0.08);

      --primary: #2563EB;
      --secondary: #7C3AED;
      --accent: #DB2777;
      --success: #10B981;
      --warning: #F59E0B;
      --danger: #EF4444;
      --cyan: #06B6D4;

      --ring: 0 0 0 4px rgba(37, 99, 235, 0.15);
      --ring2: 0 0 0 4px rgba(124, 58, 237, 0.15);

      --mode-icon: '\f185'; /* sun */
      --mode-label: 'Day Mode';
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg0);
      color: var(--text);
      line-height: 1.7;
      min-height: 100vh;
      transition: background-color 0.35s ease, color 0.35s ease;
      overflow-x: hidden;
    }

    /* Dynamic background gradients */
    body:not([data-theme="day"]) {
      background:
        radial-gradient(1200px 520px at 15% 0%, rgba(96, 165, 250, 0.18), transparent 55%),
        radial-gradient(900px 520px at 90% 10%, rgba(244, 114, 182, 0.16), transparent 55%),
        radial-gradient(900px 520px at 75% 90%, rgba(34, 211, 238, 0.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    body[data-theme="day"] {
      background:
        radial-gradient(1200px 520px at 15% 0%, rgba(37, 99, 235, 0.08), transparent 55%),
        radial-gradient(900px 520px at 90% 10%, rgba(219, 39, 119, 0.08), transparent 55%),
        radial-gradient(900px 520px at 75% 90%, rgba(6, 182, 212, 0.06), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    .container { max-width: 1400px; margin: 0 auto; padding: 22px; }

    /************************************************************
     * THEME TOGGLE
     ************************************************************/
    .theme-toggle-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }
    .theme-toggle {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 18px;
      border-radius: 50px;
      background: var(--panel);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      cursor: pointer;
      font-weight: 600;
      color: var(--text);
      backdrop-filter: blur(10px);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border: none;
      font-family: inherit;
    }
    .theme-toggle:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); }
    .theme-toggle::before {
      content: var(--mode-icon);
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      font-size: 1.1em;
    }
    .theme-toggle .label { font-size: 0.9em; opacity: 0.9; white-space: nowrap; }

    /************************************************************
     * HEADER
     ************************************************************/
    header {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.90), rgba(16, 27, 52, 0.92));
      border: 1px solid rgba(148, 163, 184, 0.18);
      color: var(--text);
      padding: 28px;
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
    body[data-theme="day"] header {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.98));
      border: 1px solid rgba(148, 163, 184, 0.25);
    }
    .course-info h1 {
      font-size: clamp(24px, 2.8vw, 38px);
      margin-bottom: 8px;
      letter-spacing: -0.5px;
      line-height: 1.2;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .course-info h2 {
      font-size: clamp(16px, 1.8vw, 20px);
      font-weight: 400;
      opacity: 0.9;
      margin-bottom: 12px;
      color: var(--muted);
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 18px;
      border-radius: 50px;
      font-weight: 700;
      letter-spacing: 0.2px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.08);
      width: fit-content;
      margin-top: 10px;
    }

    /************************************************************
     * NAVIGATION
     ************************************************************/
    .module-nav {
      display: flex;
      gap: 10px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .nav-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 50px;
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      border: none;
      font-family: inherit;
      font-size: 14px;
    }
    .nav-btn:hover { transform: translateY(-2px); border-color: var(--primary); box-shadow: var(--ring); }
    .nav-btn.active { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; }

    /************************************************************
     * MAIN CONTENT
     ************************************************************/
    .module-content { display: none; }
    .module-content.active { display: block; animation: fadeIn 0.5s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .panel {
      background: var(--panel);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      overflow: hidden;
      margin-bottom: 24px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .panel:hover { box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); transform: translateY(-2px); }
    .section { padding: 24px; }
    .section h3 {
      color: var(--text);
      margin-bottom: 20px;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    .section h4 {
      color: var(--text);
      margin: 20px 0 12px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .section p { margin-bottom: 15px; color: var(--muted); }

    /************************************************************
     * EXPANDED CONTENT STYLES
     ************************************************************/
    .expanded-content {
      margin: 20px 0;
      padding: 20px;
      background: var(--panel2);
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .numeric-example {
      font-family: var(--mono);
      background: rgba(15, 23, 42, 0.15);
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border: 1px solid var(--border);
    }
    body[data-theme="day"] .numeric-example { background: rgba(15, 23, 42, 0.05); }
    .example-title {
      color: var(--accent);
      font-weight: 600;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .formula-with-calc {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }
    @media (max-width: 768px) { .formula-with-calc { grid-template-columns: 1fr; } }
    .formula-box {
      background: rgba(15, 23, 42, 0.1);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
      font-family: var(--mono);
      text-align: center;
      position: relative;
    }
    body[data-theme="day"] .formula-box { background: rgba(15, 23, 42, 0.05); }
    .formula-label {
      position: absolute;
      top: -10px;
      left: 20px;
      background: var(--panel);
      padding: 0 10px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
    }

    /************************************************************
     * REGRESSION VISUALIZATION
     ************************************************************/
    .regression-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
      margin: 20px 0;
    }
    @media (max-width: 1100px) { .regression-container { grid-template-columns: 1fr; } }
    .regression-chart {
      height: 400px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--panel2);
      position: relative;
      overflow: hidden;
    }
    .regression-controls {
      padding: 20px;
      background: var(--panel2);
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }
    .control-group { margin-bottom: 24px; }
    .control-group h4 {
      color: var(--text);
      margin-bottom: 16px;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .slider-container { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
    .slider-container label { min-width: 160px; color: var(--muted); font-size: 14px; }
    input[type="range"] { flex: 1; height: 6px; border-radius: 3px; background: var(--border); outline: none; accent-color: var(--primary); }
    .slider-value { min-width: 50px; text-align: right; font-family: var(--mono); font-weight: 600; color: var(--text); }

    /************************************************************
     * ALGORITHM COMPARISON
     ************************************************************/
    .algorithm-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    .algorithm-card {
      background: var(--panel2);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      overflow: hidden;
      transition: transform 0.2s ease;
    }
    .algorithm-card:hover { transform: translateY(-4px); border-color: var(--primary); }
    .algorithm-header {
      padding: 16px;
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.1), rgba(167, 139, 250, 0.1));
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .algorithm-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }
    .algorithm-title { flex: 1; }
    .algorithm-title h4 { margin: 0; font-size: 16px; color: var(--text); }
    .algorithm-title p { margin: 2px 0 0; font-size: 12px; color: var(--muted); }
    .algorithm-body { padding: 16px; }
    .algorithm-metric {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 13px;
      color: var(--muted);
    }
    .algorithm-metric span:last-child { font-weight: 600; color: var(--text); }
    .algorithm-progress { height: 4px; background: var(--border); border-radius: 2px; margin: 8px 0 16px; overflow: hidden; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); border-radius: 2px; }

    /************************************************************
     * CODE EDITOR STYLES
     ************************************************************/
    .code-editor-container {
      margin: 20px 0;
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--border);
    }
    .code-header {
      background: var(--panel);
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .code-title { font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 8px; }
    .code-actions { display: flex; gap: 8px; }
    .code-body { background: var(--panel2); padding: 0; overflow: auto; }
    .code-block { font-family: var(--mono); font-size: 14px; line-height: 1.6; padding: 20px; margin: 0; tab-size: 2; white-space: pre-wrap; min-height: 200px; }
    .code-block code { display: block; color: var(--text); }
    .keyword { color: var(--danger); }
    .function { color: var(--primary); }
    .string { color: var(--success); }
    .comment { color: var(--muted2); font-style: italic; }
    .number { color: var(--warning); }
    .operator { color: var(--cyan); }

    /************************************************************
     * METRICS DISPLAY
     ************************************************************/
    .metrics-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin: 20px 0;
    }
    @media (max-width: 1100px) { .metrics-container { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 600px) { .metrics-container { grid-template-columns: 1fr; } }
    .metric-card { padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); background: var(--panel2); text-align: center; }
    .metric-value { font-size: 28px; font-weight: 700; margin: 10px 0; }
    .metric-label { font-size: 13px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .metric-good { color: var(--success); }
    .metric-warning { color: var(--warning); }
    .metric-danger { color: var(--danger); }

    /************************************************************
     * DETAILED TABLES
     ************************************************************/
    .detailed-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow: hidden;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel2);
      margin: 16px 0;
      font-size: 13px;
    }
    .detailed-table th, .detailed-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }
    .detailed-table th { background: var(--panel); color: var(--muted); font-weight: 600; }
    .detailed-table td { color: var(--text); font-family: var(--mono); }
    .detailed-table tr:last-child td { border-bottom: none; }
    .highlight-cell { background: rgba(96, 165, 250, 0.1); color: var(--primary); font-weight: 600; }

    /************************************************************
     * BUTTONS
     ************************************************************/
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      border-radius: 12px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
      font-size: 14px;
    }
    .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
    .btn-secondary { background: var(--panel); color: var(--text); border: 1px solid var(--border); }
    .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--ring); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
    .button-group { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; }

    /************************************************************
     * INFO BOXES
     ************************************************************/
    .info-box { padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin: 20px 0; }
    .info-box.warning { border-left: 4px solid var(--warning); background: rgba(251, 191, 36, 0.08); }
    .info-box.success { border-left: 4px solid var(--success); background: rgba(52, 211, 153, 0.08); }
    .info-box.danger { border-left: 4px solid var(--danger); background: rgba(251, 113, 133, 0.08); }
    .info-box.info { border-left: 4px solid var(--primary); background: rgba(96, 165, 250, 0.08); }
    .info-box h4 { color: var(--text); margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }

    /************************************************************
     * CONCEPT CARDS
     ************************************************************/
    .concept-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
    .concept-card {
      padding: 20px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--panel2);
      transition: transform 0.2s ease;
    }
    .concept-card:hover { transform: translateY(-4px); border-color: var(--primary); }
    .concept-card h5 { color: var(--text); margin-bottom: 12px; font-size: 16px; display: flex; align-items: center; gap: 10px; }
    .concept-card p { color: var(--muted); font-size: 14px; line-height: 1.6; }

    /************************************************************
     * TIMELINE STYLES
     ************************************************************/
    .timeline { position: relative; max-width: 1200px; margin: 40px auto; }
    .timeline::after {
      content: '';
      position: absolute;
      width: 4px;
      background: linear-gradient(to bottom, var(--primary), var(--secondary));
      top: 0;
      bottom: 0;
      left: 50%;
      margin-left: -2px;
      border-radius: 2px;
    }
    @media (max-width: 768px) { .timeline::after { left: 31px; } }
    .timeline-item { padding: 10px 40px; position: relative; width: 50%; box-sizing: border-box; margin: 20px 0; }
    .timeline-item:nth-child(odd) { left: 0; }
    .timeline-item:nth-child(even) { left: 50%; }
    @media (max-width: 768px) {
      .timeline-item { width: 100%; padding-left: 70px; padding-right: 25px; }
      .timeline-item:nth-child(even) { left: 0; }
    }
    .timeline-content {
      padding: 20px;
      background: var(--panel2);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      position: relative;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .timeline-content:hover { transform: translateY(-3px); box-shadow: var(--shadow); border-color: var(--primary); }
    .timeline-item:nth-child(odd) .timeline-content::after,
    .timeline-item:nth-child(even) .timeline-content::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: var(--panel2);
      border: 2px solid var(--primary);
      top: 50%;
      transform: translateY(-50%) rotate(45deg);
      border-radius: 3px;
    }
    .timeline-item:nth-child(odd) .timeline-content::after { right: -10px; }
    .timeline-item:nth-child(even) .timeline-content::after { left: -10px; }
    @media (max-width: 768px) {
      .timeline-content::after { left: -10px !important; right: auto !important; }
    }
    .timeline-icon {
      position: absolute;
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      z-index: 1;
      top: 50%;
      transform: translateY(-50%);
      right: -20px;
    }
    .timeline-item:nth-child(even) .timeline-icon { left: -20px; right: auto; }
    @media (max-width: 768px) { .timeline-icon { left: 21px !important; right: auto !important; } }
    .timeline-date { font-weight: 600; color: var(--primary); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
    .timeline-title { font-size: 1.1rem; margin-bottom: 10px; color: var(--text); }
    .timeline-description { color: var(--muted); font-size: 0.95rem; line-height: 1.6; }
    .tech-stack { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
    .tech-tag { padding: 4px 10px; background: rgba(96, 165, 250, 0.1); border-radius: 20px; font-size: 0.8rem; color: var(--primary); font-family: var(--mono); }

    /************************************************************
     * FOOTER
     ************************************************************/
    footer {
      text-align: center;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
      color: var(--muted2);
      font-size: 14px;
      line-height: 1.6;
    }

    /************************************************************
     * UTILITY CLASSES
     ************************************************************/
    .highlight { background: rgba(96, 165, 250, 0.1); padding: 2px 6px; border-radius: 4px; color: var(--primary); font-weight: 600; }
    .mono { font-family: var(--mono); background: rgba(15, 23, 42, 0.1); padding: 2px 6px; border-radius: 4px; color: var(--text); }
    .math-equation { font-family: "Times New Roman", serif; font-style: italic; font-size: 1.1em; }

    .library-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin: 2px;
    }
    .sklearn-badge { background: rgba(231, 76, 60, 0.1); color: #E74C3C; border: 1px solid rgba(231, 76, 60, 0.3); }
    .xgb-badge { background: rgba(0, 102, 102, 0.1); color: #006666; border: 1px solid rgba(0, 102, 102, 0.3); }
    .rf-badge { background: rgba(39, 174, 96, 0.1); color: #27AE60; border: 1px solid rgba(39, 174, 96, 0.3); }
    .gb-badge { background: rgba(241, 196, 15, 0.1); color: #F1C40F; border: 1px solid rgba(241, 196, 15, 0.3); }

    a { color: var(--primary); }
    a:hover { opacity: 0.9; }
  </style>
</head>

<body data-theme="night">
  <!-- Theme Toggle -->
  <div class="theme-toggle-container">
    <button class="theme-toggle" id="themeToggle" type="button" aria-label="Theme: Night Mode (click to toggle)">
      <span class="label" id="themeLabel">Night Mode</span>
    </button>
  </div>

  <div class="container">
    <header>
      <div class="course-info">
        <h1>Module 5: Supervised Machine Learning - Regression</h1>
        <h2>From Linear Models to Ensemble Methods — Extended Explanations + Datasets + Trust Checklist</h2>
        <div class="badge"><i class="fas fa-chart-line"></i> IAF 604: Predicting Continuous Values with Confidence</div>
        <p style="margin-top: 15px; color: var(--muted);">
          Learn regression algorithms (Linear, Ridge, Lasso, Trees, Random Forest, XGBoost), how to choose among them,
          how to evaluate them rigorously, and when you can trust the trained model.
        </p>
      </div>
    </header>

    <!-- Navigation -->
    <div class="module-nav">
      <button class="nav-btn active" data-module="intro"><i class="fas fa-graduation-cap"></i> 1. Introduction</button>
      <button class="nav-btn" data-module="linear-models"><i class="fas fa-chart-line"></i> 2. Linear Models</button>
      <button class="nav-btn" data-module="tree-models"><i class="fas fa-tree"></i> 3. Tree-Based</button>
      <button class="nav-btn" data-module="ensemble"><i class="fas fa-layer-group"></i> 4. Ensemble Methods</button>
      <button class="nav-btn" data-module="evaluation"><i class="fas fa-clipboard-check"></i> 5. Evaluation</button>
      <button class="nav-btn" data-module="hands-on"><i class="fas fa-laptop-code"></i> 6. Hands-On Lab</button>
      <button class="nav-btn" data-module="resources"><i class="fas fa-book"></i> 7. Resources & Datasets</button>
    </div>

    <!-- ================================================
         SECTION 1: INTRODUCTION
    ================================================= -->
    <div id="intro" class="module-content active">

      <div class="panel section">
        <h3><i class="fas fa-graduation-cap"></i> 1.1 Supervised Machine Learning (Big Picture)</h3>

        <div class="info-box info">
          <h4><i class="fas fa-brain"></i> Definition</h4>
          <p>
            <strong>Supervised Machine Learning</strong> trains a model using labeled examples. Each training row contains:
            <span class="highlight">features (X)</span> and the <span class="highlight">target (y)</span>.
            The model learns a mapping: <span class="math-equation">f(X) \rightarrow y</span>.
          </p>
          <p>
            After training, we use the learned function to predict outputs for new data. The key challenge is
            <strong>generalization</strong>: performing well on unseen cases, not just the training set.
          </p>
        </div>

        <div class="expanded-content">
          <h4><i class="fas fa-sitemap"></i> Two Main Types of Supervised Learning</h4>

          <div class="concept-grid">
            <div class="concept-card">
              <h5><i class="fas fa-chart-line"></i> Regression</h5>
              <p><strong>Goal:</strong> Predict a continuous numeric value.</p>
              <p><strong>Examples:</strong> house price, demand forecast, temperature, delivery time.</p>
              <p><strong>Typical metrics:</strong> RMSE, MAE, R².</p>
            </div>

            <div class="concept-card">
              <h5><i class="fas fa-tags"></i> Classification</h5>
              <p><strong>Goal:</strong> Predict a category (class label).</p>
              <p><strong>Examples:</strong> fraud/not fraud, churn yes/no, risk level, disease category.</p>
              <p><strong>Typical metrics:</strong> accuracy, precision, recall, F1, ROC-AUC.</p>
            </div>
          </div>

          <div class="info-box success">
            <h4><i class="fas fa-lightbulb"></i> Quick Rule</h4>
            <p>
              If <span class="highlight">y is numeric</span> → regression.<br/>
              If <span class="highlight">y is a category</span> → classification.
            </p>
          </div>
        </div>

        <h4><i class="fas fa-table"></i> Example Dataset (Supervised Learning)</h4>
        <p>
          Below is a tiny labeled dataset. Features are <span class="mono">sqft, bedrooms, age</span>. Target is <span class="mono">price</span>.
        </p>

        <table class="detailed-table">
          <thead>
            <tr>
              <th>sqft</th><th>bedrooms</th><th>age</th><th>price</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>1200</td><td>3</td><td>10</td><td>250000</td></tr>
            <tr><td>1800</td><td>4</td><td>5</td><td>450000</td></tr>
            <tr><td>950</td><td>2</td><td>20</td><td>180000</td></tr>
            <tr><td>1500</td><td>3</td><td>12</td><td>320000</td></tr>
          </tbody>
        </table>
      </div>

      <div class="panel section">
        <h3><i class="fas fa-question-circle"></i> 1.2 What is Regression?</h3>

        <div class="info-box info">
          <h4><i class="fas fa-lightbulb"></i> Core Concept</h4>
          <p>
            <strong>Regression</strong> predicts <span class="highlight">continuous numerical values</span>.
            It answers “how much?” or “how many?” and produces a real number (not a category).
          </p>
        </div>

        <div class="formula-with-calc">
          <div class="formula-box">
            <div class="formula-label">Regression Form</div>
            <div style="text-align:left; padding: 15px;">
              <strong>General form:</strong><br/>
              <span class="math-equation">y = f(X) + \varepsilon</span><br/><br/>
              Where:<br/>
              • <strong>y</strong> = target variable (continuous)<br/>
              • <strong>X</strong> = feature matrix<br/>
              • <strong>f</strong> = mapping learned from data<br/>
              • <strong>ε</strong> = noise / unobserved factors
            </div>
          </div>

          <div class="numeric-example">
            <div class="example-title"><i class="fas fa-bullseye"></i> Why Regression Errors Happen</div>
            <p>
              Two houses may have identical square footage and bedrooms but different prices because of
              school district, renovations, neighborhood trends, or timing. That unexplained variation is part of <span class="mono">ε</span>.
            </p>
            <p>
              A regression model aims to capture the systematic part of price (signal) and minimize error (noise).
            </p>
          </div>
        </div>

        <div class="expanded-content">
          <h4><i class="fas fa-list-check"></i> Typical Regression Use Cases</h4>
          <ul style="padding-left: 20px; color: var(--muted); line-height: 1.9;">
            <li><strong>Pricing:</strong> house prices, rentals, product pricing estimates</li>
            <li><strong>Forecasting:</strong> sales, demand, energy load, inventory</li>
            <li><strong>Operations:</strong> delivery time, wait time, machine failure time</li>
            <li><strong>Science/Health:</strong> lab measurement prediction, dosage prediction, risk score as a number</li>
          </ul>
        </div>

        <h4><i class="fas fa-table"></i> Simple Regression Dataset (Toy)</h4>
        <p>This toy dataset is used throughout the module to connect ideas to data.</p>

        <table class="detailed-table">
          <thead>
            <tr><th>X (feature)</th><th>y (target)</th><th>Interpretation</th></tr>
          </thead>
          <tbody>
            <tr><td>1</td><td>12</td><td>Low X → lower y</td></tr>
            <tr><td>2</td><td>14</td><td>Increasing trend</td></tr>
            <tr><td>3</td><td>18</td><td>Still increasing</td></tr>
            <tr><td>4</td><td>20</td><td>Noise exists</td></tr>
          </tbody>
        </table>
      </div>

      <div class="panel section">
        <h3><i class="fas fa-sitemap"></i> 1.3 Regression vs Classification</h3>

        <table class="detailed-table">
          <thead>
            <tr><th>Aspect</th><th>Regression</th><th>Classification</th></tr>
          </thead>
          <tbody>
            <tr><td><strong>Output type</strong></td><td>Continuous number</td><td>Discrete label</td></tr>
            <tr><td><strong>Example</strong></td><td>$250,000</td><td>“High risk”</td></tr>
            <tr><td><strong>Common loss</strong></td><td>MSE, MAE</td><td>Cross-entropy</td></tr>
            <tr><td><strong>Common evaluation</strong></td><td>RMSE, MAE, R²</td><td>Accuracy, F1, ROC-AUC</td></tr>
            <tr><td><strong>Algorithms</strong></td><td>Linear Regression, RF Regressor</td><td>Logistic Regression, RF Classifier</td></tr>
          </tbody>
        </table>

        <div class="info-box warning">
          <h4><i class="fas fa-exclamation-triangle"></i> Critical Distinction</h4>
          <p>
            Do not use classification metrics (like accuracy) to evaluate regression.
            Regression needs distance-based metrics (how close predictions are to true values).
          </p>
        </div>
      </div>

      <div class="panel section">
        <h3><i class="fas fa-road"></i> 1.4 The Regression Workflow (Expanded)</h3>

        <div class="timeline">
          <div class="timeline-item">
            <div class="timeline-icon"><i class="fas fa-database"></i></div>
            <div class="timeline-content">
              <div class="timeline-date">Step 1: Data Preparation</div>
              <div class="timeline-title">Clean, transform, and split</div>
              <div class="timeline-description">
                Handle missing values, remove impossible values, encode categories, scale if needed, and split into
                training and testing data (or use cross-validation).
              </div>
              <div class="tech-stack">
                <span class="tech-tag">Pandas</span><span class="tech-tag">ColumnTransformer</span><span class="tech-tag">train_test_split</span>
              </div>
            </div>
          </div>

          <div class="timeline-item">
            <div class="timeline-icon"><i class="fas fa-cogs"></i></div>
            <div class="timeline-content">
              <div class="timeline-date">Step 2: Model Selection</div>
              <div class="timeline-title">Start simple, increase complexity if needed</div>
              <div class="timeline-description">
                Begin with a baseline (mean predictor) then try linear models. If relationships are nonlinear,
                try trees/ensembles. Pick based on performance + interpretability.
              </div>
              <div class="tech-stack">
                <span class="tech-tag">Baseline</span><span class="tech-tag">Linear</span><span class="tech-tag">Tree</span><span class="tech-tag">Ensemble</span>
              </div>
            </div>
          </div>

          <div class="timeline-item">
            <div class="timeline-icon"><i class="fas fa-chart-line"></i></div>
            <div class="timeline-content">
              <div class="timeline-date">Step 3: Training</div>
              <div class="timeline-title">Fit model and learn patterns</div>
              <div class="timeline-description">
                The model estimates parameters (coefficients) or builds structures (trees) to minimize error on training data.
              </div>
              <div class="tech-stack">
                <span class="tech-tag">fit()</span><span class="tech-tag">Loss</span><span class="tech-tag">Optimization</span>
              </div>
            </div>
          </div>

          <div class="timeline-item">
            <div class="timeline-icon"><i class="fas fa-clipboard-check"></i></div>
            <div class="timeline-content">
              <div class="timeline-date">Step 4: Evaluation</div>
              <div class="timeline-title">Measure generalization</div>
              <div class="timeline-description">
                Evaluate with multiple metrics (RMSE, MAE, R²) on unseen data. Compare training vs testing.
              </div>
              <div class="tech-stack">
                <span class="tech-tag">RMSE</span><span class="tech-tag">MAE</span><span class="tech-tag">R²</span>
              </div>
            </div>
          </div>

          <div class="timeline-item">
            <div class="timeline-icon"><i class="fas fa-sliders-h"></i></div>
            <div class="timeline-content">
              <div class="timeline-date">Step 5: Hyperparameter Tuning</div>
              <div class="timeline-title">Optimize complexity & regularization</div>
              <div class="timeline-description">
                Use CV-based search to tune parameters (tree depth, number of trees, learning rate, regularization).
              </div>
              <div class="tech-stack">
                <span class="tech-tag">GridSearchCV</span><span class="tech-tag">RandomizedSearchCV</span><span class="tech-tag">CV</span>
              </div>
            </div>
          </div>

          <div class="timeline-item">
            <div class="timeline-icon"><i class="fas fa-rocket"></i></div>
            <div class="timeline-content">
              <div class="timeline-date">Step 6: Deployment & Monitoring</div>
              <div class="timeline-title">Operationalize & watch drift</div>
              <div class="timeline-description">
                Save the model, build an API or integrate into a pipeline. Monitor performance drift and data shift.
              </div>
              <div class="tech-stack">
                <span class="tech-tag">joblib</span><span class="tech-tag">FastAPI</span><span class="tech-tag">Monitoring</span>
              </div>
            </div>
          </div>
        </div>

        <div class="info-box info">
          <h4><i class="fas fa-magnifying-glass"></i> Practical Tip</h4>
          <p>
            If you cannot explain your data pipeline, you cannot trust your model.
            In practice, most “model failures” come from data quality, leakage, or distribution shift—not math.
          </p>
        </div>
      </div>
    </div>

    <!-- ================================================
         SECTION 2: LINEAR MODELS
    ================================================= -->
    <div id="linear-models" class="module-content">

      <div class="panel section">
        <h3><i class="fas fa-chart-line"></i> 2.1 Linear Regression — The Foundation (Expanded)</h3>

        <div class="info-box info">
          <h4><i class="fas fa-lightbulb"></i> Core Idea</h4>
          <p>
            Linear regression assumes the target is a weighted sum of the features:
            <span class="math-equation">y = \beta_0 + \beta_1x_1 + \cdots + \beta_px_p + \varepsilon</span>.
          </p>
          <p>
            The model learns coefficients <span class="mono">β</span> that minimize error, typically by minimizing
            <span class="mono">MSE</span> (mean squared error).
          </p>
        </div>

        <div class="expanded-content">
          <h4><i class="fas fa-bullseye"></i> When Should You Use Linear Regression?</h4>
          <ul style="padding-left:20px; color:var(--muted); line-height:1.9;">
            <li><strong>Interpretability matters:</strong> you want to explain feature impact (coefficients).</li>
            <li><strong>Relationships are approximately linear</strong> (or can be made linear using transformations).</li>
            <li><strong>Baseline model:</strong> good starting point before trying complex models.</li>
            <li><strong>Small/medium datasets:</strong> trains fast and is stable.</li>
          </ul>

          <div class="info-box warning">
            <h4><i class="fas fa-triangle-exclamation"></i> When Linear Regression Struggles</h4>
            <ul style="padding-left:20px; color:var(--muted); line-height:1.9;">
              <li>Strong non-linear patterns (curves, thresholds)</li>
              <li>Complex interactions (features combine in non-additive ways)</li>
              <li>High multicollinearity (features strongly correlated)</li>
              <li>Outliers dominate MSE (use robust methods or transform data)</li>
            </ul>
          </div>
        </div>

        <h4><i class="fas fa-table"></i> Linear Model Dataset Example</h4>
        <p>
          In linear regression, each coefficient represents the estimated average change in <span class="mono">y</span>
          for a one-unit change in the feature (holding other features constant).
        </p>

        <table class="detailed-table">
          <thead>
            <tr><th>sqft</th><th>bedrooms</th><th>age</th><th>price</th></tr>
          </thead>
          <tbody>
            <tr><td>1000</td><td>2</td><td>15</td><td>210000</td></tr>
            <tr><td>1400</td><td>3</td><td>10</td><td>300000</td></tr>
            <tr><td>1700</td><td>3</td><td>6</td><td>385000</td></tr>
            <tr><td>2200</td><td>4</td><td>4</td><td>520000</td></tr>
          </tbody>
        </table>

        <div class="regression-container">
          <div class="regression-chart"><canvas id="linearChart"></canvas></div>

          <div class="regression-controls">
            <div class="control-group">
              <h4><i class="fas fa-sliders-h"></i> Linear Regression Demo</h4>
              <div class="slider-container">
                <label>Noise Level:</label>
                <input type="range" id="noiseLevel" min="0" max="50" step="5" value="20">
                <span class="slider-value" id="noiseLevelValue">20</span>
              </div>
              <div class="slider-container">
                <label>Sample Size:</label>
                <input type="range" id="sampleSize" min="20" max="200" step="10" value="100">
                <span class="slider-value" id="sampleSizeValue">100</span>
              </div>
            </div>

            <div class="button-group">
              <button class="btn btn-primary" onclick="generateLinearData()">
                <i class="fas fa-sync"></i> Generate New Data
              </button>
            </div>

            <div class="metrics-container" style="margin-top: 20px;">
              <div class="metric-card">
                <div class="metric-label">True Slope</div>
                <div class="metric-value" id="trueSlope">2.5</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Estimated Slope</div>
                <div class="metric-value" id="estSlope">0.00</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">R² Score</div>
                <div class="metric-value" id="lrR2">0.00</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">MSE</div>
                <div class="metric-value" id="lrMSE">0.00</div>
              </div>
            </div>

            <div class="info-box info" style="margin-top: 20px;">
              <h4><i class="fas fa-clipboard-question"></i> Interpreting the Demo</h4>
              <p>
                Increasing <span class="mono">noise</span> makes the relationship harder to learn → R² typically decreases and MSE increases.<br/>
                Increasing <span class="mono">sample size</span> helps estimation → slope becomes more stable and metrics improve.
              </p>
            </div>
          </div>
        </div>

        <div class="code-editor-container" style="margin-top: 20px;">
          <div class="code-header">
            <div class="code-title"><i class="fab fa-python"></i> Scikit-learn Implementation</div>
            <div class="code-actions"><span class="library-badge sklearn-badge"><i class="fas fa-cube"></i> scikit-learn</span></div>
          </div>
          <div class="code-body">
            <pre class="code-block"><code><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> LinearRegression
<span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split
<span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> mean_squared_error, r2_score

<span class="comment"># Split data</span>
X_train, X_test, y_train, y_test = train_test_split(
    X, y, <span class="function">test_size</span>=<span class="number">0.2</span>, <span class="function">random_state</span>=<span class="number">42</span>
)

<span class="comment"># Create and train model</span>
model = LinearRegression()
model.<span class="function">fit</span>(X_train, y_train)

<span class="comment"># Predict</span>
y_pred = model.<span class="function">predict</span>(X_test)

<span class="comment"># Evaluate</span>
mse = mean_squared_error(y_test, y_pred)
r2 = r2_score(y_test, y_pred)

<span class="keyword">print</span>(<span class="string">f"R²: {r2:.3f}"</span>)
<span class="keyword">print</span>(<span class="string">f"MSE: {mse:.3f}"</span>)
<span class="keyword">print</span>(<span class="string">f"Coefficients: {model.coef_}"</span>)
<span class="keyword">print</span>(<span class="string">f"Intercept: {model.intercept_:.3f}"</span>)</code></pre>
          </div>
        </div>
      </div>

      <div class="panel section">
        <h3><i class="fas fa-exclamation-triangle"></i> 2.2 Regularized Linear Models (Ridge, Lasso, ElasticNet)</h3>

        <div class="info-box warning">
          <h4><i class="fas fa-fire"></i> Why Regularization?</h4>
          <p>
            When you have many features (or correlated features), ordinary linear regression can overfit.
            <strong>Regularization</strong> adds a penalty that discourages large coefficients and improves generalization.
          </p>
        </div>

        <div class="expanded-content">
          <h4><i class="fas fa-compass"></i> When to Use Each Regularized Model</h4>
          <div class="concept-grid">
            <div class="concept-card">
              <h5><i class="fas fa-mountain"></i> Ridge (L2)</h5>
              <p><strong>Use when:</strong> Many features matter a little, and features are correlated.</p>
              <p><strong>Behavior:</strong> Shrinks coefficients smoothly (rarely becomes exactly zero).</p>
              <p><strong>Outcome:</strong> Reduces variance, improves stability.</p>
            </div>
            <div class="concept-card">
              <h5><i class="fas fa-grip-lines"></i> Lasso (L1)</h5>
              <p><strong>Use when:</strong> You expect only some features are truly useful.</p>
              <p><strong>Behavior:</strong> Can drive some coefficients to exactly zero (feature selection).</p>
              <p><strong>Outcome:</strong> Sparse model, easier interpretation.</p>
            </div>
            <div class="concept-card">
              <h5><i class="fas fa-code-branch"></i> ElasticNet (L1+L2)</h5>
              <p><strong>Use when:</strong> You want Lasso-like feature selection but have correlated features.</p>
              <p><strong>Behavior:</strong> Balances sparsity (L1) and stability (L2).</p>
              <p><strong>Outcome:</strong> Often best practical choice when features correlate.</p>
            </div>
          </div>
        </div>

        <h4><i class="fas fa-table"></i> Dataset Example (High-Dimensional Features)</h4>
        <p>
          Regularization becomes more valuable when you have many features (including correlated ones).
          Example: housing + demographics + economic indicators.
        </p>
        <table class="detailed-table">
          <thead>
            <tr>
              <th>sqft</th><th>bedrooms</th><th>age</th><th>school_score</th><th>crime_rate</th><th>price</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>1600</td><td>3</td><td>8</td><td>8.7</td><td>2.1</td><td>410000</td></tr>
            <tr><td>1900</td><td>4</td><td>6</td><td>9.1</td><td>1.6</td><td>505000</td></tr>
            <tr><td>1400</td><td>3</td><td>14</td><td>7.5</td><td>3.2</td><td>295000</td></tr>
          </tbody>
        </table>

        <div class="code-editor-container" style="margin-top: 20px;">
          <div class="code-header">
            <div class="code-title"><i class="fab fa-python"></i> Regularized Regression</div>
          </div>
          <div class="code-body">
            <pre class="code-block"><code><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> Ridge, Lasso, ElasticNet
<span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> GridSearchCV

<span class="comment"># Ridge Regression</span>
ridge = Ridge()
ridge_params = {<span class="string">'alpha'</span>: [<span class="number">0.01</span>, <span class="number">0.1</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">100</span>]}
ridge_grid = GridSearchCV(ridge, ridge_params, <span class="function">cv</span>=<span class="number">5</span>, <span class="function">scoring</span>=<span class="string">'r2'</span>)
ridge_grid.<span class="function">fit</span>(X_train, y_train)

<span class="comment"># Lasso Regression</span>
lasso = Lasso(<span class="function">max_iter</span>=<span class="number">10000</span>)
lasso_params = {<span class="string">'alpha'</span>: [<span class="number">0.001</span>, <span class="number">0.01</span>, <span class="number">0.1</span>, <span class="number">1</span>, <span class="number">10</span>]}
lasso_grid = GridSearchCV(lasso, lasso_params, <span class="function">cv</span>=<span class="number">5</span>)
lasso_grid.<span class="function">fit</span>(X_train, y_train)

<span class="comment"># ElasticNet</span>
elastic = ElasticNet()
elastic_params = {
  <span class="string">'alpha'</span>: [<span class="number">0.01</span>, <span class="number">0.1</span>, <span class="number">1</span>],
  <span class="string">'l1_ratio'</span>: [<span class="number">0.2</span>, <span class="number">0.5</span>, <span class="number">0.8</span>]
}
elastic_grid = GridSearchCV(elastic, elastic_params, <span class="function">cv</span>=<span class="number">5</span>)
elastic_grid.<span class="function">fit</span>(X_train, y_train)

<span class="keyword">print</span>(<span class="string">"Best Ridge:"</span>, ridge_grid.best_params_)
<span class="keyword">print</span>(<span class="string">"Best Lasso:"</span>, lasso_grid.best_params_)
<span class="keyword">print</span>(<span class="string">"Best ElasticNet:"</span>, elastic_grid.best_params_)</code></pre>
          </div>
        </div>
      </div>
    </div>

    <!-- ================================================
         SECTION 3: TREE-BASED MODELS
    ================================================= -->
    <div id="tree-models" class="module-content">

      <div class="panel section">
        <h3><i class="fas fa-tree"></i> 3.1 Decision Trees for Regression (Expanded)</h3>

        <div class="info-box info">
          <h4><i class="fas fa-lightbulb"></i> How Decision Trees Work</h4>
          <p>
            Decision trees split the feature space into regions (using thresholds like “sqft &lt; 1500?”).
            For regression, each leaf predicts the <strong>average target value</strong> of training samples in that region.
          </p>
        </div>

        <div class="expanded-content">
          <h4><i class="fas fa-compass"></i> When to Use Decision Trees</h4>
          <ul style="padding-left:20px; color:var(--muted); line-height:1.9;">
            <li><strong>Non-linear relationships:</strong> curves, thresholds, “if-then” structure.</li>
            <li><strong>Mixed feature types:</strong> handles numeric and categorical (after encoding) well.</li>
            <li><strong>Interpretability:</strong> you can explain decision paths.</li>
          </ul>
          <div class="info-box warning">
            <h4><i class="fas fa-triangle-exclamation"></i> Big Risk: Overfitting</h4>
            <p>
              Deep trees can memorize training data. You must control depth, min samples per leaf,
              and validate using cross-validation.
            </p>
          </div>
        </div>

        <h4><i class="fas fa-table"></i> Dataset Example (Nonlinear Pattern)</h4>
        <p>Notice how the relationship could change across ranges (e.g., older homes may drop value faster).</p>
        <table class="detailed-table">
          <thead>
            <tr><th>age</th><th>sqft</th><th>neighborhood_score</th><th>price</th></tr>
          </thead>
          <tbody>
            <tr><td>2</td><td>1600</td><td>9.2</td><td>520000</td></tr>
            <tr><td>18</td><td>1600</td><td>9.2</td><td>445000</td></tr>
            <tr><td>40</td><td>1600</td><td>9.2</td><td>365000</td></tr>
            <tr><td>18</td><td>1600</td><td>6.5</td><td>360000</td></tr>
          </tbody>
        </table>

        <div class="regression-container">
          <div class="regression-chart"><canvas id="treeChart"></canvas></div>

          <div class="regression-controls">
            <div class="control-group">
              <h4><i class="fas fa-sliders-h"></i> Decision Tree Controls</h4>
              <div class="slider-container">
                <label>Max Depth:</label>
                <input type="range" id="treeDepth" min="1" max="10" step="1" value="3">
                <span class="slider-value" id="treeDepthValue">3</span>
              </div>
              <div class="slider-container">
                <label>Min Samples Split:</label>
                <input type="range" id="minSamples" min="2" max="20" step="1" value="5">
                <span class="slider-value" id="minSamplesValue">5</span>
              </div>
            </div>

            <div class="button-group">
              <button class="btn btn-primary" onclick="updateTreeModel()"><i class="fas fa-play"></i> Update Tree</button>
              <button class="btn btn-secondary" onclick="resetTreeData()"><i class="fas fa-redo"></i> New Data</button>
            </div>

            <div class="metrics-container" style="margin-top: 20px;">
              <div class="metric-card">
                <div class="metric-label">Train R²</div>
                <div class="metric-value" id="treeTrainR2">0.85</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Test R²</div>
                <div class="metric-value" id="treeTestR2">0.78</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Leaves</div>
                <div class="metric-value" id="treeLeaves">8</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Depth</div>
                <div class="metric-value" id="treeCurrentDepth">3</div>
              </div>
            </div>

            <div class="info-box warning" style="margin-top: 20px;">
              <h4><i class="fas fa-exclamation-triangle"></i> How to Spot Overfitting</h4>
              <p>
                If <span class="mono">Train R²</span> keeps increasing but <span class="mono">Test R²</span> drops,
                the tree is too complex. Reduce depth, increase <span class="mono">min_samples_leaf</span>, or use an ensemble.
              </p>
            </div>
          </div>
        </div>

        <div class="code-editor-container" style="margin-top: 20px;">
          <div class="code-header">
            <div class="code-title"><i class="fab fa-python"></i> Decision Tree Regressor (Sklearn)</div>
          </div>
          <div class="code-body">
            <pre class="code-block"><code><span class="keyword">from</span> sklearn.tree <span class="keyword">import</span> DecisionTreeRegressor
<span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_val_score

tree = DecisionTreeRegressor(
    <span class="function">max_depth</span>=<span class="number">5</span>,
    <span class="function">min_samples_split</span>=<span class="number">10</span>,
    <span class="function">min_samples_leaf</span>=<span class="number">5</span>,
    <span class="function">random_state</span>=<span class="number">42</span>
)

tree.<span class="function">fit</span>(X_train, y_train)

cv_scores = cross_val_score(tree, X_train, y_train, <span class="function">cv</span>=<span class="number">5</span>, <span class="function">scoring</span>=<span class="string">'r2'</span>)
<span class="keyword">print</span>(<span class="string">f"CV R²: {cv_scores.mean():.3f} (+/- {cv_scores.std()*2:.3f})"</span>)</code></pre>
          </div>
        </div>
      </div>
    </div>

    <!-- ================================================
         SECTION 4: ENSEMBLE METHODS
    ================================================= -->
    <div id="ensemble" class="module-content">

      <div class="panel section">
        <h3><i class="fas fa-layer-group"></i> 4.1 Ensemble Learning Philosophy (Expanded)</h3>

        <div class="info-box info">
          <h4><i class="fas fa-users"></i> Why Ensembles Work</h4>
          <p>
            Ensembles combine multiple models to reduce error. Intuition:
            <strong>one model</strong> might make mistakes in some regions, but averaging multiple models reduces those mistakes.
          </p>
        </div>

        <div class="concept-grid">
          <div class="concept-card">
            <h5><i class="fas fa-random"></i> Bagging</h5>
            <p><strong>Idea:</strong> Train many models independently on bootstrap samples, then average predictions.</p>
            <p class="highlight">Main effect: reduces variance (stability)</p>
            <p><strong>Example:</strong> Random Forest</p>
          </div>
          <div class="concept-card">
            <h5><i class="fas fa-arrow-up"></i> Boosting</h5>
            <p><strong>Idea:</strong> Train models sequentially; each new model focuses on errors from earlier models.</p>
            <p class="highlight">Main effect: reduces bias (accuracy)</p>
            <p><strong>Example:</strong> Gradient Boosting, XGBoost</p>
          </div>
          <div class="concept-card">
            <h5><i class="fas fa-cubes"></i> Stacking</h5>
            <p><strong>Idea:</strong> Use predictions of base models as inputs to a meta-model.</p>
            <p class="highlight">Main effect: combine strengths of different algorithms</p>
            <p><strong>Example:</strong> StackingRegressor</p>
          </div>
        </div>

        <h4><i class="fas fa-table"></i> Dataset Example (Same Features, Better Performance)</h4>
        <p>
          Ensembles often help when patterns are complex and linear assumptions fail.
        </p>
        <table class="detailed-table">
          <thead>
            <tr><th>X (feature)</th><th>y (nonlinear)</th><th>Note</th></tr>
          </thead>
          <tbody>
            <tr><td>-4</td><td>18</td><td>Non-linear curvature</td></tr>
            <tr><td>-1</td><td>9</td><td>Different slope region</td></tr>
            <tr><td>2</td><td>14</td><td>Curve rising again</td></tr>
            <tr><td>5</td><td>30</td><td>Large increase</td></tr>
          </tbody>
        </table>
      </div>

      <div class="panel section">
        <h3><i class="fas fa-tree"></i> 4.2 Random Forest Regressor (Expanded)</h3>

        <div class="expanded-content">
          <h4><i class="fas fa-compass"></i> When to Use Random Forest</h4>
          <ul style="padding-left:20px; color:var(--muted); line-height:1.9;">
            <li><strong>Strong baseline for tabular data:</strong> handles nonlinearity and interactions.</li>
            <li><strong>Less tuning than boosting:</strong> works well out-of-the-box.</li>
            <li><strong>Robust:</strong> less sensitive to outliers than linear models.</li>
            <li><strong>Interpretation:</strong> feature importance gives insight (but still not a causal claim).</li>
          </ul>
          <div class="info-box warning">
            <h4><i class="fas fa-hourglass-half"></i> Tradeoffs</h4>
            <p>
              Random forests can be slower and heavier than linear models. For very large datasets,
              consider boosting with careful tuning or simpler models for deployment.
            </p>
          </div>
        </div>

        <h4><i class="fas fa-table"></i> Dataset Example (Nonlinear + Interactions)</h4>
        <table class="detailed-table">
          <thead>
            <tr><th>sqft</th><th>age</th><th>renovated</th><th>price</th></tr>
          </thead>
          <tbody>
            <tr><td>1600</td><td>30</td><td>no</td><td>290000</td></tr>
            <tr><td>1600</td><td>30</td><td>yes</td><td>345000</td></tr>
            <tr><td>2200</td><td>5</td><td>no</td><td>520000</td></tr>
          </tbody>
        </table>

        <div class="regression-container">
          <div class="regression-chart"><canvas id="rfChart"></canvas></div>

          <div class="regression-controls">
            <div class="control-group">
              <h4><i class="fas fa-sliders-h"></i> Random Forest Controls</h4>
              <div class="slider-container">
                <label>Number of Trees:</label>
                <input type="range" id="nEstimators" min="10" max="200" step="10" value="100">
                <span class="slider-value" id="nEstimatorsValue">100</span>
              </div>
              <div class="slider-container">
                <label>Max Depth:</label>
                <input type="range" id="rfDepth" min="3" max="20" step="1" value="10">
                <span class="slider-value" id="rfDepthValue">10</span>
              </div>
            </div>

            <div class="button-group">
              <button class="btn btn-primary" onclick="updateRandomForest()"><i class="fas fa-play"></i> Update Forest</button>
            </div>

            <div class="metrics-container" style="margin-top: 20px;">
              <div class="metric-card">
                <div class="metric-label">Train R²</div>
                <div class="metric-value" id="rfTrainR2">0.95</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Test R²</div>
                <div class="metric-value" id="rfTestR2">0.89</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">OOB Score</div>
                <div class="metric-value" id="rfOOB">0.87</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Trees</div>
                <div class="metric-value" id="rfTrees">100</div>
              </div>
            </div>

            <div class="info-box info" style="margin-top: 20px;">
              <h4><i class="fas fa-circle-info"></i> Interpretation</h4>
              <p>
                Increasing trees usually improves stability (variance reduction). Very deep trees can overfit.
                OOB is a built-in “almost test-like” estimate for Random Forest (when bootstrap=True).
              </p>
            </div>
          </div>
        </div>

        <div class="code-editor-container" style="margin-top: 20px;">
          <div class="code-header">
            <div class="code-title"><i class="fab fa-python"></i> Random Forest Regressor</div>
            <div class="code-actions"><span class="library-badge rf-badge"><i class="fas fa-tree"></i> RandomForest</span></div>
          </div>
          <div class="code-body">
            <pre class="code-block"><code><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestRegressor
<span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> RandomizedSearchCV

rf = RandomForestRegressor(
    <span class="function">n_estimators</span>=<span class="number">200</span>,
    <span class="function">max_depth</span>=<span class="number">15</span>,
    <span class="function">min_samples_leaf</span>=<span class="number">2</span>,
    <span class="function">oob_score</span>=<span class="keyword">True</span>,
    <span class="function">random_state</span>=<span class="number">42</span>,
    <span class="function">n_jobs</span>=-<span class="number">1</span>
)

rf.<span class="function">fit</span>(X_train, y_train)
<span class="keyword">print</span>(<span class="string">f"OOB: {rf.oob_score_:.3f}"</span>)
<span class="keyword">print</span>(<span class="string">f"Test R²: {rf.score(X_test, y_test):.3f}"</span>)</code></pre>
          </div>
        </div>
      </div>

      <div class="panel section">
        <h3><i class="fas fa-bolt"></i> 4.3 Gradient Boosting / XGBoost (Expanded)</h3>

        <div class="info-box success">
          <h4><i class="fas fa-trophy"></i> Why Boosting Often Wins</h4>
          <p>
            Boosting builds models sequentially, where each new model focuses on correcting previous errors.
            It can achieve high accuracy on complex tabular datasets.
          </p>
        </div>

        <div class="expanded-content">
          <h4><i class="fas fa-compass"></i> When to Use XGBoost (or Gradient Boosting)</h4>
          <ul style="padding-left:20px; color:var(--muted); line-height:1.9;">
            <li><strong>Highest performance is needed</strong> (competitions, mission-critical predictive accuracy).</li>
            <li><strong>Complex patterns</strong> where linear models fail.</li>
            <li><strong>You can tune hyperparameters</strong> and manage overfitting with regularization + early stopping.</li>
          </ul>
          <div class="info-box warning">
            <h4><i class="fas fa-screwdriver-wrench"></i> Cost</h4>
            <p>
              Boosting has more hyperparameters and can overfit if you use deep trees or too many boosting rounds.
              Use early stopping + validation carefully.
            </p>
          </div>
        </div>

        <h4><i class="fas fa-table"></i> Dataset Example (Where Boosting Helps)</h4>
        <table class="detailed-table">
          <thead>
            <tr><th>feature_1</th><th>feature_2</th><th>feature_3</th><th>target</th></tr>
          </thead>
          <tbody>
            <tr><td>0.12</td><td>5.4</td><td>1</td><td>18.6</td></tr>
            <tr><td>0.55</td><td>2.1</td><td>0</td><td>12.2</td></tr>
            <tr><td>0.80</td><td>7.8</td><td>1</td><td>26.4</td></tr>
          </tbody>
        </table>

        <div class="code-editor-container" style="margin-top: 20px;">
          <div class="code-header">
            <div class="code-title"><i class="fab fa-python"></i> XGBoost Implementation</div>
            <div class="code-actions"><span class="library-badge xgb-badge"><i class="fas fa-bolt"></i> XGBoost</span></div>
          </div>
          <div class="code-body">
            <pre class="code-block"><code><span class="comment"># Install: pip install xgboost</span>
<span class="keyword">import</span> xgboost <span class="keyword">as</span> xgb
<span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_val_score

xgb_model = xgb.XGBRegressor(
    <span class="function">n_estimators</span>=<span class="number">300</span>,
    <span class="function">max_depth</span>=<span class="number">6</span>,
    <span class="function">learning_rate</span>=<span class="number">0.05</span>,
    <span class="function">subsample</span>=<span class="number">0.8</span>,
    <span class="function">colsample_bytree</span>=<span class="number">0.8</span>,
    <span class="function">reg_alpha</span>=<span class="number">0.1</span>,
    <span class="function">reg_lambda</span>=<span class="number">1.0</span>,
    <span class="function">random_state</span>=<span class="number">42</span>
)

xgb_model.<span class="function">fit</span>(
  X_train, y_train,
  <span class="function">eval_set</span>=[(X_test, y_test)],
  <span class="function">eval_metric</span>=<span class="string">'rmse'</span>,
  <span class="function">early_stopping_rounds</span>=<span class="number">20</span>,
  <span class="function">verbose</span>=<span class="keyword">False</span>
)

scores = cross_val_score(xgb_model, X_train, y_train, <span class="function">cv</span>=<span class="number">5</span>, <span class="function">scoring</span>=<span class="string">'r2'</span>)
<span class="keyword">print</span>(<span class="string">f"CV R²: {scores.mean():.3f} (+/- {scores.std() * 2:.3f})"</span>)</code></pre>
          </div>
        </div>
      </div>
    </div>

    <!-- ================================================
         SECTION 5: EVALUATION
    ================================================= -->
    <div id="evaluation" class="module-content">

      <div class="panel section">
        <h3><i class="fas fa-clipboard-check"></i> 5.1 Regression Metrics (Expanded + Steps)</h3>

        <div class="info-box info">
          <h4><i class="fas fa-ruler"></i> Why Multiple Metrics?</h4>
          <p>
            Different metrics answer different questions:
            <strong>MAE</strong> = typical error size,
            <strong>RMSE</strong> = punishes large errors,
            <strong>R²</strong> = variance explained relative to a baseline.
          </p>
        </div>

        <h4><i class="fas fa-table"></i> Example Dataset (Actual vs Predicted)</h4>
        <table class="detailed-table">
          <thead>
            <tr><th>Actual (y)</th><th>Predicted (ŷ)</th></tr>
          </thead>
          <tbody>
            <tr><td>100</td><td>95</td></tr>
            <tr><td>150</td><td>160</td></tr>
            <tr><td>200</td><td>190</td></tr>
            <tr><td>80</td><td>85</td></tr>
          </tbody>
        </table>

        <div class="expanded-content">
          <h4><i class="fas fa-calculator"></i> Step-by-Step: How to Calculate Metrics</h4>

          <p><strong>Step 1 — Errors:</strong> compute <span class="mono">e = y − ŷ</span></p>
          <div class="numeric-example">Errors = [5, -10, 10, -5]</div>

          <p><strong>Step 2 — MAE:</strong> average absolute errors</p>
          <div class="numeric-example">
            |errors| = [5, 10, 10, 5]<br/>
            MAE = (5+10+10+5) / 4 = <strong>7.5</strong>
          </div>

          <p><strong>Step 3 — MSE:</strong> average squared errors</p>
          <div class="numeric-example">
            errors² = [25, 100, 100, 25]<br/>
            MSE = (25+100+100+25) / 4 = <strong>62.5</strong>
          </div>

          <p><strong>Step 4 — RMSE:</strong> square root of MSE</p>
          <div class="numeric-example">RMSE = √62.5 = <strong>7.91</strong></div>

          <p><strong>Step 5 — R²:</strong> compare residual error to baseline (mean predictor)</p>
          <div class="numeric-example">
            1) Compute mean of y: ȳ = (100+150+200+80)/4 = 132.5<br/>
            2) SST = Σ(y − ȳ)²<br/>
            3) SSR = Σ(y − ŷ)²<br/>
            4) R² = 1 − (SSR / SST)
          </div>

          <div class="info-box warning">
            <h4><i class="fas fa-exclamation-triangle"></i> Interpretation Warning</h4>
            <p>
              A “good” RMSE depends on the scale of y. RMSE=10 might be great for predicting salaries (in thousands),
              but terrible for predicting temperature.
            </p>
          </div>
        </div>
      </div>

      <div class="panel section">
        <h3><i class="fas fa-chart-bar"></i> 5.2 Cross-Validation (Expanded)</h3>

        <div class="info-box warning">
          <h4><i class="fas fa-exclamation-triangle"></i> Never Trust a Single Train/Test Split</h4>
          <p>
            One split can be “lucky” (easy test set) or “unlucky” (hard test set).
            Cross-validation measures performance across multiple splits and gives a more reliable estimate.
          </p>
        </div>

        <h4><i class="fas fa-table"></i> Dataset Example (Splits)</h4>
        <table class="detailed-table">
          <thead>
            <tr><th>Fold</th><th>Train Rows</th><th>Validation Rows</th><th>What You Measure</th></tr>
          </thead>
          <tbody>
            <tr><td>1</td><td>80%</td><td>20%</td><td>Validation R²</td></tr>
            <tr><td>2</td><td>80%</td><td>20%</td><td>Validation R²</td></tr>
            <tr><td>3</td><td>80%</td><td>20%</td><td>Validation R²</td></tr>
            <tr><td>4</td><td>80%</td><td>20%</td><td>Validation R²</td></tr>
            <tr><td>5</td><td>80%</td><td>20%</td><td>Validation R²</td></tr>
          </tbody>
        </table>

        <div class="code-editor-container" style="margin-top: 20px;">
          <div class="code-header">
            <div class="code-title"><i class="fab fa-python"></i> Cross-Validation Example</div>
          </div>
          <div class="code-body">
            <pre class="code-block"><code><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_val_score
<span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestRegressor
<span class="keyword">import</span> numpy <span class="keyword">as</span> np

model = RandomForestRegressor(<span class="function">n_estimators</span>=<span class="number">200</span>, <span class="function">random_state</span>=<span class="number">42</span>)
scores = cross_val_score(model, X, y, <span class="function">cv</span>=<span class="number">5</span>, <span class="function">scoring</span>=<span class="string">'r2'</span>)

<span class="keyword">print</span>(<span class="string">"Fold scores:"</span>, scores)
<span class="keyword">print</span>(<span class="string">f"Mean R²: {scores.mean():.3f}"</span>)
<span class="keyword">print</span>(<span class="string">f"Std R²: {scores.std():.3f}"</span>)</code></pre>
          </div>
        </div>
      </div>

      <div class="panel section">
        <h3><i class="fas fa-sliders-h"></i> 5.3 Hyperparameter Tuning (Expanded)</h3>

        <div class="expanded-content">
          <h4><i class="fas fa-compass"></i> Why Tune?</h4>
          <p>
            Hyperparameters control model complexity. Example: a deeper tree can fit training data better,
            but may generalize worse. Tuning searches for the best tradeoff using cross-validation.
          </p>
          <ul style="padding-left:20px; color:var(--muted); line-height:1.9;">
            <li><strong>Grid Search:</strong> exhaustive over a small set</li>
            <li><strong>Random Search:</strong> efficient in high-dimensional spaces</li>
            <li><strong>Bayesian:</strong> smarter search using past results</li>
          </ul>
        </div>

        <h4><i class="fas fa-table"></i> Example Parameter Grid</h4>
        <table class="detailed-table">
          <thead>
            <tr><th>Parameter</th><th>Meaning</th><th>Typical Values</th></tr>
          </thead>
          <tbody>
            <tr><td>n_estimators</td><td>Number of trees</td><td>100, 200, 500</td></tr>
            <tr><td>max_depth</td><td>Tree depth</td><td>5, 10, 20, None</td></tr>
            <tr><td>min_samples_leaf</td><td>Leaf size</td><td>1, 2, 4</td></tr>
          </tbody>
        </table>

        <div class="code-editor-container" style="margin-top: 20px;">
          <div class="code-header">
            <div class="code-title"><i class="fab fa-python"></i> Grid Search Example</div>
          </div>
          <div class="code-body">
            <pre class="code-block"><code><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> GridSearchCV
<span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestRegressor

param_grid = {
  <span class="string">'n_estimators'</span>: [<span class="number">100</span>, <span class="number">200</span>],
  <span class="string">'max_depth'</span>: [<span class="number">10</span>, <span class="number">20</span>, <span class="keyword">None</span>],
  <span class="string">'min_samples_leaf'</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>],
}

grid = GridSearchCV(
  RandomForestRegressor(<span class="function">random_state</span>=<span class="number">42</span>),
  param_grid,
  <span class="function">cv</span>=<span class="number">5</span>,
  <span class="function">scoring</span>=<span class="string">'r2'</span>,
  <span class="function">n_jobs</span>=-<span class="number">1</span>
)

grid.<span class="function">fit</span>(X_train, y_train)
<span class="keyword">print</span>(grid.best_params_, grid.best_score_)</code></pre>
          </div>
        </div>
      </div>

      <div class="panel section">
        <h3><i class="fas fa-shield-halved"></i> 5.4 When Can We Trust a Trained Model?</h3>

        <div class="info-box info">
          <h4><i class="fas fa-check-circle"></i> Trust Checklist</h4>
          <p>
            You can trust a model when evidence suggests it will generalize and remain stable in your real setting.
          </p>
        </div>

        <div class="expanded-content">
          <h4><i class="fas fa-list-check"></i> Conditions for Trust</h4>
          <ol style="padding-left:22px; color:var(--muted); line-height:1.9;">
            <li><strong>Generalization:</strong> test performance close to training performance.</li>
            <li><strong>Cross-validation stability:</strong> mean is good and variance is low.</li>
            <li><strong>No leakage:</strong> preprocessing is fit only on training folds (pipeline).</li>
            <li><strong>Reasonable errors:</strong> RMSE/MAE acceptable for decisions being made.</li>
            <li><strong>Sanity checks:</strong> predictions align with domain logic for typical cases.</li>
            <li><strong>Stress testing:</strong> examine performance on edge cases and rare groups.</li>
            <li><strong>Monitoring plan:</strong> detect drift after deployment.</li>
          </ol>

          <div class="info-box warning">
            <h4><i class="fas fa-triangle-exclamation"></i> Common Red Flags</h4>
            <ul style="padding-left:20px; color:var(--muted); line-height:1.9;">
              <li>Train R² ≫ Test R² (classic overfitting)</li>
              <li>Very high performance that disappears when features are removed (possible leakage)</li>
              <li>Model breaks on new time periods or new neighborhoods (distribution shift)</li>
            </ul>
          </div>

          <div class="info-box success">
            <h4><i class="fas fa-balance-scale"></i> Practical Rule</h4>
            <p>
              Trust grows when the model is consistent across folds, performs well on truly unseen data,
              passes domain sanity checks, and has a monitoring plan after deployment.
            </p>
          </div>
        </div>

        <h4><i class="fas fa-table"></i> Example: Training vs Test Comparison</h4>
        <table class="detailed-table">
          <thead>
            <tr><th>Model</th><th>Train R²</th><th>Test R²</th><th>Interpretation</th></tr>
          </thead>
          <tbody>
            <tr><td>Linear</td><td>0.72</td><td>0.68</td><td>Stable, acceptable</td></tr>
            <tr><td>Tree (deep)</td><td>0.99</td><td>0.62</td><td>Overfitting likely</td></tr>
            <tr><td>Random Forest</td><td>0.90</td><td>0.85</td><td>Strong and stable</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ================================================
         SECTION 6: HANDS-ON LAB
    ================================================= -->
    <div id="hands-on" class="module-content">

      <div class="panel section">
        <h3><i class="fas fa-laptop-code"></i> 6.1 Interactive Regression Lab (Expanded)</h3>

        <div class="info-box success">
          <h4><i class="fas fa-flask"></i> Goal</h4>
          <p>
            Use the same dataset and compare algorithms. The key learning is <strong>model selection</strong>:
            pick the simplest model that meets performance and trust requirements.
          </p>
        </div>

        <div class="expanded-content">
          <h4><i class="fas fa-compass"></i> When to Use Which Model (Quick Guide)</h4>
          <ul style="padding-left:20px; color:var(--muted); line-height:1.9;">
            <li><strong>Linear Regression:</strong> baseline, interpretable, roughly linear patterns.</li>
            <li><strong>Ridge:</strong> many correlated features; stabilize coefficients.</li>
            <li><strong>Lasso:</strong> feature selection; sparse model desired.</li>
            <li><strong>Decision Tree:</strong> nonlinearity; interpretability; careful about overfitting.</li>
            <li><strong>Random Forest:</strong> strong general baseline for tabular data; robust.</li>
            <li><strong>XGBoost:</strong> high accuracy; many knobs; use early stopping.</li>
          </ul>
        </div>

        <h4><i class="fas fa-table"></i> Dataset Used in the Lab</h4>
        <table class="detailed-table">
          <thead>
            <tr><th>X</th><th>y</th><th>Notes</th></tr>
          </thead>
          <tbody>
            <tr><td>-6.2</td><td>22.1</td><td>nonlinear + noise</td></tr>
            <tr><td>-1.5</td><td>9.8</td><td>different slope</td></tr>
            <tr><td>3.0</td><td>18.4</td><td>curving upward</td></tr>
            <tr><td>7.4</td><td>35.2</td><td>rapid growth</td></tr>
          </tbody>
        </table>

        <div class="regression-container">
          <div class="regression-chart"><canvas id="comparisonChart"></canvas></div>

          <div class="regression-controls">
            <div class="control-group">
              <h4><i class="fas fa-cogs"></i> Algorithm Selection</h4>
              <div class="button-group" style="flex-direction: column; gap: 10px;">
                <button class="btn btn-secondary" onclick="compareAlgorithm('linear')" style="width: 100%; justify-content: flex-start;">
                  <i class="fas fa-chart-line"></i> Linear Regression
                </button>
                <button class="btn btn-secondary" onclick="compareAlgorithm('ridge')" style="width: 100%; justify-content: flex-start;">
                  <i class="fas fa-mountain"></i> Ridge (demo)
                </button>
                <button class="btn btn-secondary" onclick="compareAlgorithm('lasso')" style="width: 100%; justify-content: flex-start;">
                  <i class="fas fa-grip-lines"></i> Lasso (demo)
                </button>
                <button class="btn btn-secondary" onclick="compareAlgorithm('tree')" style="width: 100%; justify-content: flex-start;">
                  <i class="fas fa-tree"></i> Decision Tree (demo)
                </button>
                <button class="btn btn-secondary" onclick="compareAlgorithm('rf')" style="width: 100%; justify-content: flex-start;">
                  <i class="fas fa-random"></i> Random Forest (demo)
                </button>
                <button class="btn btn-secondary" onclick="compareAlgorithm('xgb')" style="width: 100%; justify-content: flex-start;">
                  <i class="fas fa-bolt"></i> XGBoost (demo)
                </button>
              </div>
            </div>

            <div class="metrics-container" style="margin-top: 20px;">
              <div class="metric-card">
                <div class="metric-label">Algorithm</div>
                <div class="metric-value" id="currentAlgo">Linear</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Train R²</div>
                <div class="metric-value" id="algoTrainR2">0.72</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Test R²</div>
                <div class="metric-value" id="algoTestR2">0.68</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">RMSE</div>
                <div class="metric-value" id="algoRMSE">12.4</div>
              </div>
            </div>

            <div class="info-box info" style="margin-top: 20px;">
              <h4><i class="fas fa-lightbulb"></i> How to Choose</h4>
              <p>
                Prefer a model with good <span class="mono">test R²</span> (and low RMSE) that is stable across CV folds.
                If two models perform similarly, choose the simpler or more interpretable one.
              </p>
            </div>
          </div>
        </div>

        <div class="algorithm-grid" style="margin-top: 30px;">
          <div class="algorithm-card" id="algoLinear">
            <div class="algorithm-header">
              <div class="algorithm-icon"><i class="fas fa-chart-line"></i></div>
              <div class="algorithm-title">
                <h4>Linear Regression</h4><p>Simple, interpretable</p>
              </div>
            </div>
            <div class="algorithm-body">
              <div class="algorithm-metric"><span>Best for:</span><span>Linear patterns</span></div>
              <div class="algorithm-metric"><span>Pros:</span><span>Fast, explainable</span></div>
              <div class="algorithm-metric"><span>Cons:</span><span>Misses nonlinearity</span></div>
              <div class="algorithm-progress"><div class="progress-bar" style="width: 70%" id="linearScore"></div></div>
            </div>
          </div>

          <div class="algorithm-card" id="algoRidge">
            <div class="algorithm-header">
              <div class="algorithm-icon"><i class="fas fa-mountain"></i></div>
              <div class="algorithm-title">
                <h4>Ridge Regression</h4><p>L2 regularization</p>
              </div>
            </div>
            <div class="algorithm-body">
              <div class="algorithm-metric"><span>Best for:</span><span>Correlated features</span></div>
              <div class="algorithm-metric"><span>Pros:</span><span>Stable coefficients</span></div>
              <div class="algorithm-metric"><span>Cons:</span><span>No sparsity</span></div>
              <div class="algorithm-progress"><div class="progress-bar" style="width: 72%" id="ridgeScore"></div></div>
            </div>
          </div>

          <div class="algorithm-card" id="algoLasso">
            <div class="algorithm-header">
              <div class="algorithm-icon"><i class="fas fa-grip-lines"></i></div>
              <div class="algorithm-title">
                <h4>Lasso Regression</h4><p>L1 regularization</p>
              </div>
            </div>
            <div class="algorithm-body">
              <div class="algorithm-metric"><span>Best for:</span><span>Feature selection</span></div>
              <div class="algorithm-metric"><span>Pros:</span><span>Sparse model</span></div>
              <div class="algorithm-metric"><span>Cons:</span><span>Unstable with correlation</span></div>
              <div class="algorithm-progress"><div class="progress-bar" style="width: 71%" id="lassoScore"></div></div>
            </div>
          </div>

          <div class="algorithm-card" id="algoTree">
            <div class="algorithm-header">
              <div class="algorithm-icon"><i class="fas fa-tree"></i></div>
              <div class="algorithm-title">
                <h4>Decision Tree</h4><p>Non-linear, interpretable</p>
              </div>
            </div>
            <div class="algorithm-body">
              <div class="algorithm-metric"><span>Best for:</span><span>Threshold patterns</span></div>
              <div class="algorithm-metric"><span>Pros:</span><span>No scaling</span></div>
              <div class="algorithm-metric"><span>Cons:</span><span>Overfits</span></div>
              <div class="algorithm-progress"><div class="progress-bar" style="width: 78%" id="treeScore"></div></div>
            </div>
          </div>

          <div class="algorithm-card" id="algoRF">
            <div class="algorithm-header">
              <div class="algorithm-icon"><i class="fas fa-random"></i></div>
              <div class="algorithm-title">
                <h4>Random Forest</h4><p>Bagging ensemble</p>
              </div>
            </div>
            <div class="algorithm-body">
              <div class="algorithm-metric"><span>Best for:</span><span>General tabular data</span></div>
              <div class="algorithm-metric"><span>Pros:</span><span>Robust</span></div>
              <div class="algorithm-metric"><span>Cons:</span><span>Heavier</span></div>
              <div class="algorithm-progress"><div class="progress-bar" style="width: 89%" id="rfScore"></div></div>
            </div>
          </div>

          <div class="algorithm-card" id="algoXGB">
            <div class="algorithm-header">
              <div class="algorithm-icon"><i class="fas fa-bolt"></i></div>
              <div class="algorithm-title">
                <h4>XGBoost</h4><p>Boosting ensemble</p>
              </div>
            </div>
            <div class="algorithm-body">
              <div class="algorithm-metric"><span>Best for:</span><span>Highest accuracy</span></div>
              <div class="algorithm-metric"><span>Pros:</span><span>State-of-the-art</span></div>
              <div class="algorithm-metric"><span>Cons:</span><span>More tuning</span></div>
              <div class="algorithm-progress"><div class="progress-bar" style="width: 92%" id="xgbScore"></div></div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel section">
        <h3><i class="fas fa-code"></i> 6.2 Production-Ready Regression Pipeline</h3>

        <div class="expanded-content">
          <h4><i class="fas fa-shield"></i> Why Use Pipelines?</h4>
          <p>
            Pipelines prevent data leakage by ensuring preprocessing is learned from training data only.
            This is essential for honest evaluation and trust.
          </p>
        </div>

        <div class="code-editor-container" style="margin-top: 20px;">
          <div class="code-header">
            <div class="code-title"><i class="fab fa-python"></i> Pipeline Template</div>
          </div>
          <div class="code-body">
            <pre class="code-block"><code><span class="keyword">import</span> pandas <span class="keyword">as</span> pd
<span class="keyword">import</span> numpy <span class="keyword">as</span> np
<span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split, cross_val_score
<span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> StandardScaler, OneHotEncoder
<span class="keyword">from</span> sklearn.compose <span class="keyword">import</span> ColumnTransformer
<span class="keyword">from</span> sklearn.pipeline <span class="keyword">import</span> Pipeline
<span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestRegressor
<span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> mean_squared_error, r2_score
<span class="keyword">import</span> joblib

df = pd.<span class="function">read_csv</span>(<span class="string">'housing_sample.csv'</span>)
X = df.<span class="function">drop</span>(<span class="string">'price'</span>, axis=<span class="number">1</span>)
y = df[<span class="string">'price'</span>]

num_cols = [<span class="string">'sqft'</span>, <span class="string">'age'</span>]
cat_cols = [<span class="string">'style'</span>]

preprocess = ColumnTransformer(
  transformers=[
    (<span class="string">'num'</span>, Pipeline([(<span class="string">'scaler'</span>, StandardScaler())]), num_cols),
    (<span class="string">'cat'</span>, Pipeline([(<span class="string">'oh'</span>, OneHotEncoder(<span class="function">handle_unknown</span>=<span class="string">'ignore'</span>))]), cat_cols),
  ]
)

model = RandomForestRegressor(<span class="function">n_estimators</span>=<span class="number">200</span>, <span class="function">random_state</span>=<span class="number">42</span>)

pipe = Pipeline(steps=[
  (<span class="string">'preprocess'</span>, preprocess),
  (<span class="string">'model'</span>, model),
])

X_train, X_test, y_train, y_test = train_test_split(X, y, <span class="function">test_size</span>=<span class="number">0.2</span>, <span class="function">random_state</span>=<span class="number">42</span>)

pipe.<span class="function">fit</span>(X_train, y_train)
pred = pipe.<span class="function">predict</span>(X_test)

<span class="keyword">print</span>(<span class="string">"Test R²:"</span>, r2_score(y_test, pred))
<span class="keyword">print</span>(<span class="string">"Test RMSE:"</span>, np.<span class="function">sqrt</span>(mean_squared_error(y_test, pred)))

joblib.<span class="function">dump</span>(pipe, <span class="string">'best_model.pkl'</span>)</code></pre>
          </div>
        </div>
      </div>
    </div>

    <!-- ================================================
         SECTION 7: RESOURCES & DATASETS
    ================================================= -->
    <div id="resources" class="module-content">

      <div class="panel section">
        <h3><i class="fas fa-book"></i> 7.1 Additional Learning Resources</h3>

        <div class="concept-grid">
          <div class="concept-card">
            <h5><i class="fas fa-book-open"></i> Books</h5>
            <ul style="padding-left:18px; color:var(--muted); line-height:1.8;">
              <li><strong>Hands-On Machine Learning</strong> — Aurélien Géron</li>
              <li><strong>Introduction to Statistical Learning (ISLR)</strong></li>
              <li><strong>Elements of Statistical Learning</strong> — Hastie, Tibshirani, Friedman</li>
            </ul>
          </div>

          <div class="concept-card">
            <h5><i class="fas fa-graduation-cap"></i> Courses</h5>
            <ul style="padding-left:18px; color:var(--muted); line-height:1.8;">
              <li>Coursera Machine Learning (Andrew Ng)</li>
              <li>Fast.ai Practical Deep Learning</li>
              <li>MIT OpenCourseWare Machine Learning</li>
            </ul>
          </div>

          <div class="concept-card">
            <h5><i class="fas fa-database"></i> Dataset Repositories</h5>
            <ul style="padding-left:18px; color:var(--muted); line-height:1.8;">
              <li><a href="https://www.kaggle.com/datasets" target="_blank" rel="noreferrer">Kaggle Datasets</a></li>
              <li><a href="https://archive.ics.uci.edu/ml/index.php" target="_blank" rel="noreferrer">UCI ML Repository</a></li>
              <li><a href="https://scikit-learn.org/stable/datasets.html" target="_blank" rel="noreferrer">scikit-learn Datasets</a></li>
              <li><a href="https://data.gov" target="_blank" rel="noreferrer">Data.gov</a></li>
            </ul>
          </div>
        </div>
      </div>

      <div class="panel section">
        <h3><i class="fas fa-download"></i> 7.2 Download Practice Datasets (Built In)</h3>

        <div class="info-box success">
          <h4><i class="fas fa-file-csv"></i> One-Click Downloads</h4>
          <p>
            Click a button to download a small CSV dataset for classroom practice. These are simple and intentionally small.
            For larger real datasets, use the repositories above.
          </p>

          <div class="button-group">
            <button class="btn btn-primary" onclick="downloadDataset('housing_sample.csv')">
              <i class="fas fa-download"></i> Download Housing Sample (CSV)
            </button>
            <button class="btn btn-secondary" onclick="downloadDataset('synthetic_regression.csv')">
              <i class="fas fa-download"></i> Download Synthetic Regression (CSV)
            </button>
          </div>
        </div>

        <h4><i class="fas fa-table"></i> Preview: housing_sample.csv</h4>
        <table class="detailed-table">
          <thead>
            <tr><th>sqft</th><th>age</th><th>style</th><th>price</th></tr>
          </thead>
          <tbody>
            <tr><td>1200</td><td>10</td><td>ranch</td><td>250000</td></tr>
            <tr><td>1800</td><td>5</td><td>colonial</td><td>450000</td></tr>
            <tr><td>950</td><td>20</td><td>bungalow</td><td>180000</td></tr>
            <tr><td>1600</td><td>8</td><td>townhome</td><td>360000</td></tr>
          </tbody>
        </table>

        <h4><i class="fas fa-table"></i> Preview: synthetic_regression.csv</h4>
        <table class="detailed-table">
          <thead>
            <tr><th>x</th><th>y</th></tr>
          </thead>
          <tbody>
            <tr><td>-6.2</td><td>22.1</td></tr>
            <tr><td>-1.5</td><td>9.8</td></tr>
            <tr><td>3.0</td><td>18.4</td></tr>
            <tr><td>7.4</td><td>35.2</td></tr>
          </tbody>
        </table>
      </div>

      <div class="panel section">
        <h3><i class="fas fa-link"></i> 7.3 External Dataset Download Links</h3>
        <div class="info-box info">
          <h4><i class="fas fa-globe"></i> Recommended Public Datasets</h4>
          <ul style="padding-left:20px; color:var(--muted); line-height:1.9;">
            <li><a href="https://www.kaggle.com/datasets" target="_blank" rel="noreferrer">Kaggle: Browse datasets</a></li>
            <li><a href="https://archive.ics.uci.edu/ml/index.php" target="_blank" rel="noreferrer">UCI ML Repository</a></li>
            <li><a href="https://scikit-learn.org/stable/modules/generated/sklearn.datasets.fetch_california_housing.html" target="_blank" rel="noreferrer">California Housing (Sklearn)</a></li>
          </ul>
        </div>
      </div>
    </div>

    <footer>
      Module 5: IAF 604 Supervised Machine Learning — Regression (Extended)<br/>
      Linear Models • Trees • Ensembles • Metrics • Trust Checklist • Datasets<br/>
      © 2026
    </footer>
  </div>

  <script>
    /************************************************************
     * GLOBAL VARIABLES AND STATE
     ************************************************************/
    let linearChart = null;
    let treeChart = null;
    let rfChart = null;
    let comparisonChart = null;

    let currentData = { X: [], y: [] };

    /************************************************************
     * THEME MANAGEMENT
     ************************************************************/
    const themeToggle = document.getElementById('themeToggle');
    const themeLabel = document.getElementById('themeLabel');
    const body = document.body;
    const THEME_KEY = 'iaf604-theme';

    function applyTheme(theme) {
      body.setAttribute('data-theme', theme);
      const isDay = theme === 'day';
      themeLabel.textContent = isDay ? 'Day Mode' : 'Night Mode';
      themeToggle.setAttribute('aria-label', `Theme: ${themeLabel.textContent} (click to toggle)`);
      updateChartColors();
    }

    function initTheme() {
      const savedTheme = localStorage.getItem(THEME_KEY);
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

      if (savedTheme === 'day' || savedTheme === 'night') {
        applyTheme(savedTheme);
      } else {
        const defaultTheme = prefersDark ? 'night' : 'day';
        applyTheme(defaultTheme);
        localStorage.setItem(THEME_KEY, defaultTheme);
      }
    }

    function toggleTheme() {
      const current = body.getAttribute('data-theme');
      const next = current === 'night' ? 'day' : 'night';
      applyTheme(next);
      localStorage.setItem(THEME_KEY, next);
    }

    themeToggle.addEventListener('click', toggleTheme);

    /************************************************************
     * MODULE NAVIGATION
     ************************************************************/
    function switchModule(moduleId) {
      document.querySelectorAll('.module-content').forEach(module => module.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));

      document.getElementById(moduleId).classList.add('active');
      document.querySelector(`.nav-btn[data-module="${moduleId}"]`).classList.add('active');

      // Initialize module-specific charts
      if (moduleId === 'linear-models') {
        setTimeout(() => { initLinearChart(); generateLinearData(); }, 100);
      } else if (moduleId === 'tree-models') {
        setTimeout(() => { initTreeChart(); generateTreeData(); }, 100);
      } else if (moduleId === 'ensemble') {
        setTimeout(() => { initRFChart(); generateRFData(); }, 100);
      } else if (moduleId === 'hands-on') {
        setTimeout(() => { initComparisonChart(); generateComparisonData(); }, 100);
      }
    }

    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', () => switchModule(btn.dataset.module));
    });

    /************************************************************
     * CHART MANAGEMENT
     ************************************************************/
    function getChartColors() {
      const isDay = body.getAttribute('data-theme') === 'day';
      return {
        primary: isDay ? 'rgba(37, 99, 235, 0.8)' : 'rgba(96, 165, 250, 0.8)',
        secondary: isDay ? 'rgba(124, 58, 237, 0.8)' : 'rgba(167, 139, 250, 0.8)',
        success: isDay ? 'rgba(16, 185, 129, 0.8)' : 'rgba(52, 211, 153, 0.8)',
        danger: isDay ? 'rgba(239, 68, 68, 0.8)' : 'rgba(251, 113, 133, 0.8)',
        warning: isDay ? 'rgba(245, 158, 11, 0.8)' : 'rgba(251, 191, 36, 0.8)',
        grid: isDay ? 'rgba(148, 163, 184, 0.25)' : 'rgba(148, 163, 184, 0.14)',
        text: isDay ? '#0F172A' : '#EAF0FF',
        background: isDay ? '#FFFFFF' : '#0F172A'
      };
    }

    function updateChartColors() {
      const colors = getChartColors();
      [linearChart, treeChart, rfChart, comparisonChart].forEach(chart => {
        if (!chart) return;
        if (chart.options.scales) {
          if (chart.options.scales.x) {
            chart.options.scales.x.grid.color = colors.grid;
            chart.options.scales.x.ticks.color = colors.text;
            if (chart.options.scales.x.title) chart.options.scales.x.title.color = colors.text;
          }
          if (chart.options.scales.y) {
            chart.options.scales.y.grid.color = colors.grid;
            chart.options.scales.y.ticks.color = colors.text;
            if (chart.options.scales.y.title) chart.options.scales.y.title.color = colors.text;
          }
        }
        if (chart.options.plugins && chart.options.plugins.legend) {
          chart.options.plugins.legend.labels.color = colors.text;
        }
        chart.update();
      });
    }

    /************************************************************
     * LINEAR REGRESSION DEMO
     ************************************************************/
    function initLinearChart() {
      const ctx = document.getElementById('linearChart');
      if (!ctx) return;

      const colors = getChartColors();
      if (linearChart) linearChart.destroy();

      linearChart = new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [{
            label: 'Data Points',
            data: [],
            backgroundColor: colors.primary,
            pointRadius: 4
          }, {
            label: 'Regression Line',
            data: [],
            type: 'line',
            borderColor: colors.success,
            borderWidth: 3,
            pointRadius: 0,
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { labels: { color: colors.text } } },
          scales: {
            x: {
              title: { display: true, text: 'Feature X', color: colors.text },
              grid: { color: colors.grid },
              ticks: { color: colors.text }
            },
            y: {
              title: { display: true, text: 'Target y', color: colors.text },
              grid: { color: colors.grid },
              ticks: { color: colors.text }
            }
          }
        }
      });
    }

    function generateLinearData() {
      const noiseEl = document.getElementById('noiseLevel');
      const sampleEl = document.getElementById('sampleSize');
      if (!noiseEl || !sampleEl) return;

      const noiseLevel = parseFloat(noiseEl.value);
      const sampleSize = parseInt(sampleEl.value);

      document.getElementById('noiseLevelValue').textContent = noiseLevel;
      document.getElementById('sampleSizeValue').textContent = sampleSize;

      const trueSlope = 2.5;
      const trueIntercept = 10;

      const X = [];
      const y = [];

      for (let i = 0; i < sampleSize; i++) {
        const x = Math.random() * 20;
        const noise = (Math.random() - 0.5) * noiseLevel;
        const target = trueIntercept + trueSlope * x + noise;
        X.push(x);
        y.push(target);
      }

      // Regression (closed-form for 1 feature)
      const n = X.length;
      const sumX = X.reduce((a, b) => a + b, 0);
      const sumY = y.reduce((a, b) => a + b, 0);
      const sumXY = X.reduce((sum, xi, i) => sum + xi * y[i], 0);
      const sumX2 = X.reduce((sum, xi) => sum + xi * xi, 0);

      const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
      const intercept = (sumY - slope * sumX) / n;

      // R²
      const yMean = sumY / n;
      const ssTot = y.reduce((sum, yi) => sum + (yi - yMean) ** 2, 0);
      const ssRes = y.reduce((sum, yi, i) => sum + (yi - (intercept + slope * X[i])) ** 2, 0);
      const r2 = 1 - ssRes / ssTot;

      // MSE
      const mse = ssRes / n;

      document.getElementById('trueSlope').textContent = trueSlope.toFixed(2);
      document.getElementById('estSlope').textContent = slope.toFixed(2);
      document.getElementById('lrR2').textContent = r2.toFixed(3);
      document.getElementById('lrMSE').textContent = mse.toFixed(2);

      if (linearChart) {
        linearChart.data.datasets[0].data = X.map((x, i) => ({ x, y: y[i] }));
        const minX = Math.min(...X);
        const maxX = Math.max(...X);
        linearChart.data.datasets[1].data = [
          { x: minX, y: intercept + slope * minX },
          { x: maxX, y: intercept + slope * maxX }
        ];
        linearChart.update();
      }
    }

    /************************************************************
     * DECISION TREE DEMO (SIMULATED SHAPE)
     ************************************************************/
    function initTreeChart() {
      const ctx = document.getElementById('treeChart');
      if (!ctx) return;

      const colors = getChartColors();
      if (treeChart) treeChart.destroy();

      treeChart = new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [{
            label: 'Training Data',
            data: [],
            backgroundColor: colors.primary,
            pointRadius: 4
          }, {
            label: 'Tree Predictions',
            data: [],
            type: 'line',
            borderColor: colors.success,
            borderWidth: 3,
            pointRadius: 0,
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { labels: { color: colors.text } } },
          scales: {
            x: {
              title: { display: true, text: 'Feature X', color: colors.text },
              grid: { color: colors.grid },
              ticks: { color: colors.text }
            },
            y: {
              title: { display: true, text: 'Target y', color: colors.text },
              grid: { color: colors.grid },
              ticks: { color: colors.text }
            }
          }
        }
      });
    }

    function generateTreeData() {
      const X = [];
      const y = [];
      for (let i = 0; i < 100; i++) {
        const x = Math.random() * 20 - 10;
        const target = 5 + 2 * x + 0.5 * x * x + (Math.random() - 0.5) * 20;
        X.push(x);
        y.push(target);
      }
      currentData = { X, y };
      updateTreeModel();
    }

    function updateTreeModel() {
      const depthEl = document.getElementById('treeDepth');
      const minEl = document.getElementById('minSamples');
      if (!depthEl || !minEl) return;

      const depth = parseInt(depthEl.value);
      const minSamples = parseInt(minEl.value);

      document.getElementById('treeDepthValue').textContent = depth;
      document.getElementById('minSamplesValue').textContent = minSamples;
      document.getElementById('treeCurrentDepth').textContent = depth;

      const X = currentData.X || Array.from({ length: 100 }, () => Math.random() * 20 - 10);
      const y = currentData.y || X.map(x => 5 + 2 * x + 0.5 * x * x + (Math.random() - 0.5) * 20);

      const sortedIndices = X.map((_, i) => i).sort((a, b) => X[a] - X[b]);
      const sortedX = sortedIndices.map(i => X[i]);
      const sortedY = sortedIndices.map(i => y[i]);

      const treePred = [];
      const nSegments = depth + 2;
      const segmentSize = Math.max(1, Math.floor(sortedX.length / nSegments));

      for (let i = 0; i < sortedX.length; i++) {
        const segment = Math.floor(i / segmentSize);
        const segStart = segment * segmentSize;
        const segEnd = Math.min(sortedY.length, (segment + 1) * segmentSize);
        const segmentY = sortedY.slice(segStart, segEnd);
        const meanY = segmentY.reduce((a, b) => a + b, 0) / (segmentY.length || 1);
        treePred.push(meanY);
      }

      const yMean = y.reduce((a, b) => a + b, 0) / y.length;
      const ssTot = y.reduce((sum, yi) => sum + (yi - yMean) ** 2, 0);
      const ssRes = y.reduce((sum, yi, i) => sum + (yi - treePred[sortedIndices.indexOf(i)]) ** 2, 0);
      const trainR2 = 1 - ssRes / ssTot;

      const testR2 = Math.max(0, trainR2 - 0.07 - (depth * 0.02));
      const leaves = Math.pow(2, depth);

      document.getElementById('treeTrainR2').textContent = trainR2.toFixed(3);
      document.getElementById('treeTestR2').textContent = testR2.toFixed(3);
      document.getElementById('treeLeaves').textContent = leaves;

      if (treeChart) {
        treeChart.data.datasets[0].data = X.map((x, i) => ({ x, y: y[i] }));
        treeChart.data.datasets[1].data = sortedX.map((x, i) => ({ x, y: treePred[i] }));
        treeChart.update();
      }
    }

    function resetTreeData() { generateTreeData(); }

    /************************************************************
     * RANDOM FOREST DEMO (SIMULATED SMOOTHER)
     ************************************************************/
    function initRFChart() {
      const ctx = document.getElementById('rfChart');
      if (!ctx) return;

      const colors = getChartColors();
      if (rfChart) rfChart.destroy();

      rfChart = new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [{
            label: 'Data Points',
            data: [],
            backgroundColor: colors.primary,
            pointRadius: 3
          }, {
            label: 'Random Forest (Smoothed)',
            data: [],
            type: 'line',
            borderColor: colors.success,
            borderWidth: 3,
            pointRadius: 0,
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { labels: { color: colors.text } } },
          scales: {
            x: {
              title: { display: true, text: 'Feature X', color: colors.text },
              grid: { color: colors.grid },
              ticks: { color: colors.text }
            },
            y: {
              title: { display: true, text: 'Target y', color: colors.text },
              grid: { color: colors.grid },
              ticks: { color: colors.text }
            }
          }
        }
      });
    }

    function generateRFData() {
      const nEl = document.getElementById('nEstimators');
      const dEl = document.getElementById('rfDepth');
      if (!nEl || !dEl) return;

      const nEstimators = parseInt(nEl.value);
      const depth = parseInt(dEl.value);

      document.getElementById('nEstimatorsValue').textContent = nEstimators;
      document.getElementById('rfDepthValue').textContent = depth;
      document.getElementById('rfTrees').textContent = nEstimators;

      const X = [];
      const y = [];
      for (let i = 0; i < 150; i++) {
        const x = Math.random() * 20 - 10;
        const target = 3 + 1.5 * x + 0.3 * x * x - 0.1 * x * x * x + (Math.random() - 0.5) * 15;
        X.push(x);
        y.push(target);
      }

      const sortedIndices = X.map((_, i) => i).sort((a, b) => X[a] - X[b]);
      const sortedX = sortedIndices.map(i => X[i]);
      const sortedY = sortedIndices.map(i => y[i]);

      const rfPred = [];
      const windowSize = Math.max(5, Math.floor(30 / Math.sqrt(nEstimators / 50)));

      for (let i = 0; i < sortedX.length; i++) {
        const start = Math.max(0, i - windowSize);
        const end = Math.min(sortedX.length, i + windowSize + 1);
        const windowY = sortedY.slice(start, end);
        const meanY = windowY.reduce((a, b) => a + b, 0) / (windowY.length || 1);
        rfPred.push(meanY);
      }

      const yMean = y.reduce((a, b) => a + b, 0) / y.length;
      const ssTot = y.reduce((sum, yi) => sum + (yi - yMean) ** 2, 0);

      const ssResTrain = y.reduce((sum, yi, i) => {
        const idxInSorted = sortedIndices.indexOf(i);
        return sum + (yi - rfPred[idxInSorted]) ** 2;
      }, 0);

      const trainR2 = 1 - ssResTrain / ssTot;
      const testR2 = Math.min(0.95, trainR2 - 0.05 - (depth * 0.005));
      const oobScore = testR2 - 0.02;

      document.getElementById('rfTrainR2').textContent = trainR2.toFixed(3);
      document.getElementById('rfTestR2').textContent = testR2.toFixed(3);
      document.getElementById('rfOOB').textContent = oobScore.toFixed(3);

      if (rfChart) {
        rfChart.data.datasets[0].data = X.map((x, i) => ({ x, y: y[i] }));
        rfChart.data.datasets[1].data = sortedX.map((x, i) => ({ x, y: rfPred[i] }));
        rfChart.update();
      }
    }

    function updateRandomForest() { generateRFData(); }

    /************************************************************
     * COMPARISON CHART
     ************************************************************/
    function initComparisonChart() {
      const ctx = document.getElementById('comparisonChart');
      if (!ctx) return;

      const colors = getChartColors();
      if (comparisonChart) comparisonChart.destroy();

      comparisonChart = new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [{
            label: 'Data',
            data: [],
            backgroundColor: colors.primary,
            pointRadius: 3
          }, {
            label: 'Model',
            data: [],
            type: 'line',
            borderColor: colors.success,
            borderWidth: 3,
            pointRadius: 0,
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { labels: { color: colors.text } } },
          scales: {
            x: { title: { display: true, text: 'Feature X', color: colors.text }, grid: { color: colors.grid }, ticks: { color: colors.text } },
            y: { title: { display: true, text: 'Target y', color: colors.text }, grid: { color: colors.grid }, ticks: { color: colors.text } }
          }
        }
      });
    }

    function generateComparisonData() {
      const X = [];
      const y = [];
      for (let i = 0; i < 100; i++) {
        const x = Math.random() * 20 - 10;
        const target = 5 + 2 * x + 0.4 * x * x + (Math.random() - 0.5) * 10;
        X.push(x);
        y.push(target);
      }
      currentData = { X, y };

      if (comparisonChart) {
        comparisonChart.data.datasets[0].data = X.map((x, i) => ({ x, y: y[i] }));
        comparisonChart.update();
      }
      compareAlgorithm('linear');
    }

    function compareAlgorithm(algo) {
      const X = currentData.X || Array.from({ length: 100 }, () => Math.random() * 20 - 10);
      const y = currentData.y || X.map(x => 5 + 2 * x + 0.4 * x * x + (Math.random() - 0.5) * 10);

      const sortedIndices = X.map((_, i) => i).sort((a, b) => X[a] - X[b]);
      const sortedX = sortedIndices.map(i => X[i]);

      let predictions = [];
      let trainR2 = 0, testR2 = 0, rmse = 0;
      let algoName = '';

      switch(algo) {
        case 'linear': {
          algoName = 'Linear';
          const n = X.length;
          const sumX = X.reduce((a, b) => a + b, 0);
          const sumY = y.reduce((a, b) => a + b, 0);
          const sumXY = X.reduce((sum, xi, i) => sum + xi * y[i], 0);
          const sumX2 = X.reduce((sum, xi) => sum + xi * xi, 0);
          const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
          const intercept = (sumY - slope * sumX) / n;

          predictions = sortedX.map(x => intercept + slope * x);

          const yMean = sumY / n;
          const ssTot = y.reduce((sum, yi) => sum + (yi - yMean) ** 2, 0);
          const ssRes = y.reduce((sum, yi, i) => sum + (yi - (intercept + slope * X[i])) ** 2, 0);

          trainR2 = 1 - ssRes / ssTot;
          testR2 = trainR2 - 0.04;
          rmse = Math.sqrt(ssRes / n);
          break;
        }
        case 'ridge':
          algoName = 'Ridge';
          predictions = sortedX.map(x => 5.2 + 2.3 * x);
          trainR2 = 0.72; testR2 = 0.70; rmse = 8.2;
          break;
        case 'lasso':
          algoName = 'Lasso';
          predictions = sortedX.map(x => 5.5 + 2.1 * x);
          trainR2 = 0.71; testR2 = 0.69; rmse = 8.5;
          break;
        case 'tree': {
          algoName = 'Decision Tree';
          const treePred = [];
          for (let i = 0; i < sortedX.length; i++) {
            const x = sortedX[i];
            if (x < -3) treePred.push(10);
            else if (x < 0) treePred.push(15);
            else if (x < 3) treePred.push(22);
            else if (x < 6) treePred.push(28);
            else treePred.push(35);
          }
          predictions = treePred;
          trainR2 = 0.78; testR2 = 0.72; rmse = 7.8;
          break;
        }
        case 'rf':
          algoName = 'Random Forest';
          predictions = sortedX.map(x => 12 + 3.5 * x - 0.1 * x * x);
          trainR2 = 0.89; testR2 = 0.85; rmse = 6.2;
          break;
        case 'xgb':
          algoName = 'XGBoost';
          predictions = sortedX.map(x => 10 + 3.8 * x - 0.15 * x * x + 0.2 * Math.sin(x));
          trainR2 = 0.92; testR2 = 0.88; rmse = 5.4;
          break;
      }

      document.getElementById('currentAlgo').textContent = algoName;
      document.getElementById('algoTrainR2').textContent = trainR2.toFixed(2);
      document.getElementById('algoTestR2').textContent = testR2.toFixed(2);
      document.getElementById('algoRMSE').textContent = rmse.toFixed(1);

      if (comparisonChart) {
        comparisonChart.data.datasets[1].data = sortedX.map((x, i) => ({ x, y: predictions[i] }));
        comparisonChart.update();
      }
    }

    /************************************************************
     * DATASET DOWNLOADS (LOCAL CSV GENERATION)
     ************************************************************/
    const DATASETS = {
      "housing_sample.csv": `sqft,age,style,price
1200,10,ranch,250000
1800,5,colonial,450000
950,20,bungalow,180000
1600,8,townhome,360000
2100,4,colonial,520000
1400,12,ranch,295000
1750,7,modern,410000
1100,18,bungalow,215000
`,
      "synthetic_regression.csv": `x,y
-6.2,22.1
-1.5,9.8
3.0,18.4
7.4,35.2
-4.1,16.6
1.2,11.9
5.8,28.7
-0.8,8.9
`
    };

    function downloadDataset(filename) {
      const content = DATASETS[filename];
      if (!content) return;

      const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      URL.revokeObjectURL(url);
    }

    /************************************************************
     * INITIALIZATION
     ************************************************************/
    document.addEventListener('DOMContentLoaded', () => {
      initTheme();

      // Sliders
      ['noiseLevel', 'sampleSize'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', generateLinearData);
      });
      ['treeDepth', 'minSamples'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', updateTreeModel);
      });
      ['nEstimators', 'rfDepth'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', generateRFData);
      });

      // Default chart init for first module that needs it
      setTimeout(() => {
        initLinearChart();
        generateLinearData();
      }, 200);

      // MathJax
      if (window.MathJax) MathJax.typesetPromise();
    });

    // Expose for inline onclick handlers
    window.switchModule = switchModule;
    window.generateLinearData = generateLinearData;
    window.updateTreeModel = updateTreeModel;
    window.resetTreeData = resetTreeData;
    window.updateRandomForest = updateRandomForest;
    window.compareAlgorithm = compareAlgorithm;
    window.generateComparisonData = generateComparisonData;
    window.downloadDataset = downloadDataset;
  </script>
</body>
</html>
